<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fit Trackr Pro - Workout Tracker</title>
    <style>
        :root {
            --color-bg: #0a0e27;
            --color-surface: #1a1f3a;
            --color-surface-hover: #252b4a;
            --color-primary: #4ECDC4;
            --color-primary-dark: #3ab8b0;
            --color-secondary: #FF6B9D;
            --color-accent: #FFD93D;
            --color-text: #e8eaf0;
            --color-text-muted: #a0a8c0;
            --color-border: rgba(78, 205, 196, 0.2);
            
            --muscle-chest: #FF6B9D;
            --muscle-back: #4ECDC4;
            --muscle-legs: #FFD93D;
            --muscle-glutes: #95E1D3;
            --muscle-shoulders: #FF8C42;
            --muscle-biceps: #6C5CE7;
            --muscle-triceps: #A29BFE;
            --muscle-forearms: #74B9FF;
            --muscle-core: #55EFC4;
            
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.3);
            --shadow-md: 0 4px 16px rgba(0,0,0,0.4);
            --shadow-lg: 0 8px 32px rgba(0,0,0,0.5);
            --radius: 16px;
            --radius-sm: 8px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--color-bg);
            color: var(--color-text);
            overflow-x: hidden;
        }
        
        .app-container {
            display: flex;
            min-height: 100vh;
        }
        
        /* Navigation */
        .nav-sidebar {
            width: 280px;
            background: var(--color-surface);
            padding: 24px;
            box-shadow: var(--shadow-lg);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 100;
            transition: transform 0.3s ease;
        }
        
        .nav-logo {
            font-size: 28px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 40px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .nav-item {
            padding: 16px 20px;
            margin-bottom: 8px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
        }
        
        .nav-item:hover {
            background: var(--color-surface-hover);
            transform: translateX(4px);
        }
        
        .nav-item.active {
            background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark));
            color: var(--color-bg);
            box-shadow: 0 4px 16px rgba(78, 205, 196, 0.3);
        }
        
        .nav-icon {
            font-size: 20px;
        }
        
        /* Main Content */
        .main-content {
            margin-left: 280px;
            flex: 1;
            padding: 32px;
            width: calc(100% - 280px);
        }
        
        .view {
            display: none;
            animation: fadeIn 0.4s ease;
        }
        
        .view.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Dashboard */
        .dashboard-grid {
            display: grid;
            gap: 24px;
        }
        
        .card {
            background: var(--color-surface);
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .card-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--color-text);
        }
        
        /* Calendar */
        .calendar {
            margin-top: 20px;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .calendar-month {
            font-size: 20px;
            font-weight: 700;
        }
        
        .calendar-nav {
            display: flex;
            gap: 12px;
        }
        
        .calendar-btn {
            background: var(--color-surface-hover);
            border: none;
            color: var(--color-text);
            padding: 8px 16px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        
        .calendar-btn:hover {
            background: var(--color-primary);
            transform: scale(1.05);
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }
        
        .calendar-day-header {
            text-align: center;
            font-weight: 700;
            padding: 12px;
            color: var(--color-text-muted);
            font-size: 12px;
        }
        
        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-sm);
            background: var(--color-bg);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            padding: 8px;
            min-height: 70px;
        }
        
        .calendar-day:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-sm);
        }
        
        .calendar-day.has-workout {
            border: 2px solid var(--color-primary);
            background: linear-gradient(135deg, rgba(78, 205, 196, 0.1), rgba(255, 107, 157, 0.1));
        }
        
        .calendar-day-number {
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .calendar-day-dots {
            display: flex;
            gap: 2px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .muscle-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        
        .calendar-day:hover .muscle-dot {
            transform: scale(1.3);
        }
        
        /* Body Map */
        .body-map-container {
            display: flex;
            gap: 32px;
            align-items: flex-start;
            flex-wrap: wrap;
        }
        
        .body-diagram {
            flex: 1;
            min-width: 300px;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .body-view-toggle {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            justify-content: center;
        }
        
        .toggle-btn {
            padding: 12px 24px;
            background: var(--color-surface-hover);
            border: 2px solid var(--color-border);
            color: var(--color-text);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        
        .toggle-btn.active {
            background: var(--color-primary);
            border-color: var(--color-primary);
            color: var(--color-bg);
        }
        
        .toggle-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }
        
        .body-svg-wrapper {
            background: var(--color-bg);
            border-radius: var(--radius);
            padding: 24px;
            display: flex;
            justify-content: center;
        }
        
        #bodySvg {
            max-width: 100%;
            height: auto;
        }
        
        .muscle-group {
            cursor: pointer;
            transition: all 0.3s ease;
            opacity: 0.7;
        }
        
        .muscle-group:hover {
            opacity: 1;
            filter: brightness(1.3);
            stroke-width: 3;
        }
        
        .muscle-group.active {
            opacity: 1;
            filter: brightness(1.2) drop-shadow(0 0 10px currentColor);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { filter: brightness(1.2); }
            50% { filter: brightness(1.5); }
        }
        
        .muscle-stats {
            flex: 1;
            min-width: 300px;
        }
        
        .muscle-stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: var(--color-bg);
            border-radius: var(--radius-sm);
            margin-bottom: 12px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .muscle-stat-item:hover {
            transform: translateX(4px);
            box-shadow: var(--shadow-sm);
        }
        
        .muscle-name {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
        }
        
        .muscle-color-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .muscle-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--color-primary);
        }
        
        /* Metrics Tracker */
        .metrics-controls {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }
        
        .metric-select {
            flex: 1;
            min-width: 200px;
            padding: 12px 16px;
            background: var(--color-bg);
            border: 2px solid var(--color-border);
            border-radius: var(--radius-sm);
            color: var(--color-text);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            height: 44px;
            width: 100%;
        }
        
        .metric-select:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(78, 205, 196, 0.2);
        }
        
        .add-metric-btn {
            padding: 12px 24px;
            background: var(--color-primary);
            border: none;
            border-radius: var(--radius-sm);
            color: var(--color-bg);
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .add-metric-btn:hover {
            background: var(--color-primary-dark);
            transform: scale(1.05);
        }
        
        .chart-container {
            background: var(--color-bg);
            border-radius: var(--radius-sm);
            padding: 24px;
            margin-top: 24px;
            height: 400px;
        }
        
        /* Exercise Library */
        .exercise-filters {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            flex: 1;
            min-width: 200px;
        }
        
        .filter-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--color-text-muted);
            font-size: 14px;
        }
        
        .exercise-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .exercise-card {
            background: var(--color-bg);
            border-radius: var(--radius);
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .exercise-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
            border-color: var(--color-primary);
        }
        
        .exercise-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }
        
        .exercise-name {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .exercise-muscles {
            font-size: 12px;
            color: var(--color-text-muted);
            margin-bottom: 4px;
        }
        
        .exercise-equipment {
            display: inline-block;
            padding: 4px 12px;
            background: var(--color-surface-hover);
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-top: 8px;
        }
        
        .add-exercise-btn {
            padding: 8px 16px;
            background: var(--color-primary);
            border: none;
            border-radius: var(--radius-sm);
            color: var(--color-bg);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        .add-exercise-btn:hover {
            background: var(--color-primary-dark);
            transform: scale(1.05);
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 14, 39, 0.95);
            backdrop-filter: blur(10px);
            z-index: 1000;
            overflow-y: auto;
            animation: fadeIn 0.3s ease;
        }
        
        .modal.active {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 40px 20px;
        }
        
        .modal-content {
            background: var(--color-surface);
            border-radius: var(--radius);
            padding: 32px;
            max-width: 900px;
            width: 100%;
            box-shadow: var(--shadow-lg);
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .modal-title {
            font-size: 28px;
            font-weight: 700;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: var(--color-text);
            font-size: 32px;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        
        .modal-close:hover {
            background: var(--color-surface-hover);
            transform: rotate(90deg);
        }
        
        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 24px 0;
        }
        
        .video-wrapper {
            position: relative;
            padding-bottom: 56.25%;
            height: 0;
            overflow: hidden;
            border-radius: var(--radius-sm);
        }
        
        .video-wrapper iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }
        
        .kpi-form {
            background: var(--color-bg);
            padding: 24px;
            border-radius: var(--radius-sm);
            margin-top: 24px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-label {
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--color-text-muted);
            font-size: 14px;
        }
        
        .form-input {
            padding: 12px 16px;
            background: var(--color-surface);
            border: 2px solid var(--color-border);
            border-radius: var(--radius-sm);
            color: var(--color-text);
            font-size: 14px;
            transition: all 0.3s ease;
            width: 100%;
            height: 44px;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(78, 205, 196, 0.2);
        }
        
        input[type="date"].form-input {
            height: 44px;
        }
        
        .form-submit {
            padding: 12px 32px;
            background: var(--color-primary);
            border: none;
            border-radius: var(--radius-sm);
            color: var(--color-bg);
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
        }
        
        .form-submit:hover {
            background: var(--color-primary-dark);
            transform: scale(1.05);
        }
        
        /* Workout Detail Modal */
        .workout-detail {
            margin-top: 24px;
        }
        
        .exercise-log {
            background: var(--color-bg);
            padding: 16px;
            border-radius: var(--radius-sm);
            margin-bottom: 12px;
        }
        
        .exercise-log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .exercise-log-name {
            font-weight: 700;
            font-size: 16px;
        }
        
        .exercise-log-details {
            color: var(--color-text-muted);
            font-size: 14px;
        }
        
        /* Exercise History Chart */
        .history-chart {
            background: var(--color-bg);
            border-radius: var(--radius-sm);
            padding: 24px;
            margin-top: 24px;
        }
        
        .history-chart-header {
            margin-bottom: 16px;
        }
        
        .history-chart-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        /* Stats Summary */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .stat-card {
            background: var(--color-bg);
            padding: 20px;
            border-radius: var(--radius-sm);
            text-align: center;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--color-primary);
            margin-bottom: 8px;
        }
        
        .stat-label {
            color: var(--color-text-muted);
            font-size: 14px;
            font-weight: 600;
        }
        
        /* Bottom Navigation */
        .bottom-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--color-surface);
            box-shadow: 0 -4px 16px rgba(0, 0, 0, 0.4);
            z-index: 100;
            padding: 12px 0;
        }
        
        .bottom-nav-items {
            display: flex;
            justify-content: space-around;
            align-items: center;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: var(--radius-sm);
            color: var(--color-text-muted);
        }
        
        .bottom-nav-item.active {
            color: var(--color-primary);
        }
        
        .bottom-nav-item:active {
            transform: scale(0.95);
        }
        
        .bottom-nav-icon {
            font-size: 24px;
        }
        
        .bottom-nav-label {
            font-size: 11px;
            font-weight: 600;
        }
        
        /* Responsive */
        @media (max-width: 1024px) {
            .nav-sidebar {
                display: none;
            }
            
            .main-content {
                margin-left: 0;
                width: 100%;
                padding-bottom: 80px;
            }
            
            .bottom-nav {
                display: block;
            }
        }
        
        .mobile-nav-toggle {
            display: none;
        }
        
        /* Loading State */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 60px;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--color-surface-hover);
            border-top-color: var(--color-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--color-text-muted);
        }
        
        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        .empty-state-text {
            font-size: 18px;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Navigation -->
        <nav class="nav-sidebar" id="navSidebar">
            <div class="nav-logo">üí™ Fit Trackr Pro</div>
            <div class="nav-item active" onclick="switchView('dashboard')">
                <span class="nav-icon">üìä</span>
                Dashboard
            </div>
            <div class="nav-item" onclick="switchView('exercises')">
                <span class="nav-icon">üèãÔ∏è</span>
                Exercises
            </div>
            <div class="nav-item" onclick="switchView('export')">
                <span class="nav-icon">üì•</span>
                Export Data
            </div>
            <div class="nav-item" onclick="switchView('settings')">
                <span class="nav-icon">‚öôÔ∏è</span>
                Settings
            </div>
        </nav>
        
        <!-- Main Content -->
        <main class="main-content">
            <!-- Dashboard View -->
            <div id="dashboard" class="view active">
                <div class="dashboard-grid">
                    <!-- Stats Summary -->
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Workout Overview</h2>
                        </div>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value" id="totalWorkouts">0</div>
                                <div class="stat-label">Total Workouts</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="currentStreak">0</div>
                                <div class="stat-label">Current Streak</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="weeksCompleted">0</div>
                                <div class="stat-label">Weeks (5 days)</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="thisWeekDays">0</div>
                                <div class="stat-label">This Week</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Calendar -->
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Workout Calendar</h2>
                        </div>
                        <div class="calendar">
                            <div class="calendar-header">
                                <div class="calendar-month" id="calendarMonth">October 2025</div>
                                <div class="calendar-nav">
                                    <button class="calendar-btn" onclick="changeMonth(-1)">‚Üê Prev</button>
                                    <button class="calendar-btn" onclick="changeMonth(1)">Next ‚Üí</button>
                                </div>
                            </div>
                            <div class="calendar-grid" id="calendarGrid">
                                <!-- Calendar will be rendered here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Muscle Stats - Body Map Removed -->
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Muscle Group Activity</h2>
                            <select class="metric-select" id="muscleActivityPeriod" onchange="renderMuscleStats()" style="max-width: 200px; flex: none;">
                                <option value="30">Last 30 Days</option>
                                <option value="180">Last 6 Months</option>
                                <option value="365">Last 1 Year</option>
                                <option value="all">All Time</option>
                            </select>
                        </div>
                        <div id="muscleStatsList">
                            <!-- Muscle stats will be rendered here -->
                        </div>
                    </div>
                    
                    <!-- Metrics Tracker -->
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Body Metrics</h2>
                        </div>
                        <div class="metrics-controls">
                            <select class="metric-select" id="metricSelect" onchange="updateMetricChart()">
                                <option value="weight">Weight (kg)</option>
                                <option value="bodyFat">Body Fat %</option>
                                <option value="bmi">BMI</option>
                            </select>
                            <button class="add-metric-btn" onclick="showAddMetricModal()">
                                <span>+</span> Add Metric
                            </button>
                        </div>
                        <div class="chart-container">
                            <canvas id="metricsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Exercises View -->
            <div id="exercises" class="view">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Exercise Library</h2>
                        <button class="add-metric-btn" onclick="showAddExerciseModal()">
                            <span>+</span> Add Exercise
                        </button>
                    </div>
                    
                    <div class="exercise-filters">
                        <div class="filter-group" style="flex: 2;">
                            <label class="filter-label">Search Exercises</label>
                            <input type="text" class="form-input" id="exerciseSearch" placeholder="Search by name..." oninput="filterExercises()">
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Muscle Group</label>
                            <select class="metric-select" id="muscleFilter" onchange="filterExercises()">
                                <option value="all">All Muscle Groups</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Equipment</label>
                            <select class="metric-select" id="equipmentFilter" onchange="filterExercises()">
                                <option value="all">All Equipment</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="exercise-grid" id="exerciseGrid">
                        <!-- Exercises will be rendered here -->
                    </div>
                </div>
            </div>
            
            <!-- Settings View -->
            <div id="settings" class="view">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">‚öôÔ∏è Settings & Sync</h2>
                    </div>
                    
                    <div style="max-width: 800px;">
                        <!-- Google Sheets Sync -->
                        <div style="background: var(--color-bg); padding: 24px; border-radius: var(--radius); margin-bottom: 24px; border: 2px solid var(--color-primary);">
                            <h3 style="font-size: 20px; margin-bottom: 8px; display: flex; align-items: center; gap: 12px;">
                                <span>‚òÅÔ∏è</span> Google Sheets Sync
                            </h3>
                            <p style="color: var(--color-text-muted); margin-bottom: 20px; line-height: 1.6;">
                                Automatically sync your workouts, metrics, and exercises to Google Sheets for cross-device access and backup.
                            </p>
                            
                            <div class="form-group" style="margin-bottom: 16px;">
                                <label class="form-label">Google Apps Script Web App URL</label>
                                <input type="url" class="form-input" id="googleSheetsUrlInput" 
                                       placeholder="https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec"
                                       value="">
                                <div style="font-size: 12px; color: var(--color-text-muted); margin-top: 8px;">
                                    üìö <a href="#" onclick="showGoogleSheetsSetup(); return false;" style="color: var(--color-primary); text-decoration: underline;">View setup instructions</a>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                                <button class="add-metric-btn" onclick="saveGoogleSheetsUrl()">
                                    üíæ Save URL
                                </button>
                                <button class="add-metric-btn" onclick="syncToGoogleSheets()" style="background: var(--color-secondary);">
                                    ‚òÅÔ∏è Sync Now
                                </button>
                                <button class="calendar-btn" onclick="loadFromGoogleSheets()">
                                    ‚¨áÔ∏è Load from Sheets
                                </button>
                            </div>
                            
                            <div id="syncStatus" style="margin-top: 16px; padding: 12px; border-radius: var(--radius-sm); display: none;"></div>
                        </div>
                        
                        <!-- Auto-sync Toggle -->
                        <div style="background: var(--color-bg); padding: 20px; border-radius: var(--radius); margin-bottom: 24px;">
                            <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                <input type="checkbox" id="autoSyncToggle" onchange="toggleAutoSync()" 
                                       style="width: 20px; height: 20px; cursor: pointer;">
                                <div>
                                    <div style="font-weight: 700; font-size: 16px;">Enable Auto-Sync</div>
                                    <div style="color: var(--color-text-muted); font-size: 14px; margin-top: 4px;">
                                        Automatically sync data after every workout or metric update
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Export View -->
            <div id="export" class="view">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Export Your Data</h2>
                    </div>
                    
                    <div style="max-width: 600px;">
                        <p style="color: var(--color-text-muted); margin-bottom: 32px; line-height: 1.6;">
                            Download your workout data, body metrics, and exercise library as CSV files. 
                            These files can be opened in Excel, Google Sheets, or any spreadsheet application.
                        </p>
                        
                        <div style="display: grid; gap: 20px;">
                            <div style="background: var(--color-bg); padding: 24px; border-radius: var(--radius); border: 2px solid var(--color-border);">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <h3 style="font-size: 20px; margin-bottom: 8px; font-weight: 700;">Workout History</h3>
                                        <p style="color: var(--color-text-muted); font-size: 14px;">
                                            All your workouts with dates, exercises, sets, reps, and weights
                                        </p>
                                    </div>
                                    <button class="add-metric-btn" onclick="downloadWorkoutsCSV()" style="flex-shrink: 0; margin-left: 16px;">
                                        üì• Download
                                    </button>
                                </div>
                            </div>
                            
                            <div style="background: var(--color-bg); padding: 24px; border-radius: var(--radius); border: 2px solid var(--color-border);">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <h3 style="font-size: 20px; margin-bottom: 8px; font-weight: 700;">Body Metrics</h3>
                                        <p style="color: var(--color-text-muted); font-size: 14px;">
                                            Weight, body fat percentage, and calculated BMI over time
                                        </p>
                                    </div>
                                    <button class="add-metric-btn" onclick="downloadMetricsCSV()" style="flex-shrink: 0; margin-left: 16px;">
                                        üì• Download
                                    </button>
                                </div>
                            </div>
                            
                            <div style="background: var(--color-bg); padding: 24px; border-radius: var(--radius); border: 2px solid var(--color-border);">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <h3 style="font-size: 20px; margin-bottom: 8px; font-weight: 700;">Exercise Library</h3>
                                        <p style="color: var(--color-text-muted); font-size: 14px;">
                                            Complete list of exercises with muscle groups and equipment
                                        </p>
                                    </div>
                                    <button class="add-metric-btn" onclick="downloadExercisesCSV()" style="flex-shrink: 0; margin-left: 16px;">
                                        üì• Download
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
        </main>
    </div>
    
    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <div class="bottom-nav-items">
            <div class="bottom-nav-item active" onclick="switchViewMobile('dashboard')">
                <div class="bottom-nav-icon">üìä</div>
                <div class="bottom-nav-label">Dashboard</div>
            </div>
            <div class="bottom-nav-item" onclick="switchViewMobile('exercises')">
                <div class="bottom-nav-icon">üèãÔ∏è</div>
                <div class="bottom-nav-label">Exercises</div>
            </div>
            <div class="bottom-nav-item" onclick="switchViewMobile('export')">
                <div class="bottom-nav-icon">üì•</div>
                <div class="bottom-nav-label">Export</div>
            </div>
            <div class="bottom-nav-item" onclick="switchViewMobile('settings')">
                <div class="bottom-nav-icon">‚öôÔ∏è</div>
                <div class="bottom-nav-label">Settings</div>
            </div>
        </div>
    </div>
    
    <!-- Exercise Detail Modal -->
    <div class="modal" id="exerciseModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalExerciseName">Exercise</h2>
                <button class="modal-close" onclick="closeModal('exerciseModal')">&times;</button>
            </div>
            <div id="modalExerciseDetails">
                <!-- Exercise details will be rendered here -->
            </div>
        </div>
    </div>
    
    <!-- Workout Detail Modal -->
    <div class="modal" id="workoutModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalWorkoutDate">Workout Details</h2>
                <button class="modal-close" onclick="closeModal('workoutModal')">&times;</button>
            </div>
            <div class="workout-detail" id="workoutDetailContent">
                <!-- Workout details will be rendered here -->
            </div>
        </div>
    </div>
    
    <!-- Muscle History Modal -->
    <div class="modal" id="muscleHistoryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalMuscleName">Muscle History</h2>
                <button class="modal-close" onclick="closeModal('muscleHistoryModal')">&times;</button>
            </div>
            <div id="muscleHistoryContent">
                <!-- Muscle history will be rendered here -->
            </div>
        </div>
    </div>
    
    <!-- Add Metric Modal -->
    <div class="modal" id="addMetricModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add Body Metric</h2>
                <button class="modal-close" onclick="closeModal('addMetricModal')">&times;</button>
            </div>
            <div style="background: var(--color-bg); padding: 16px; border-radius: var(--radius-sm); margin-bottom: 24px;">
                <div style="display: flex; gap: 24px; flex-wrap: wrap;">
                    <div>
                        <div style="font-size: 12px; color: var(--color-text-muted); margin-bottom: 4px;">YOUR HEIGHT</div>
                        <div style="font-size: 18px; font-weight: 700;">5'11" (180.34 cm)</div>
                    </div>
                    <div>
                        <div style="font-size: 12px; color: var(--color-text-muted); margin-bottom: 4px;">CURRENT BMI</div>
                        <div style="font-size: 18px; font-weight: 700; color: var(--color-primary);" id="modalCurrentBMI">‚Äî</div>
                    </div>
                </div>
            </div>
            <form class="kpi-form" onsubmit="saveMetric(event)">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" class="form-input" id="metricDate" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Weight (kg)</label>
                        <input type="number" step="0.1" class="form-input" id="metricWeight" oninput="updateModalBMI()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Body Fat %</label>
                        <input type="number" step="0.1" class="form-input" id="metricBodyFat">
                    </div>
                </div>
                <button type="submit" class="form-submit">Save Metric</button>
            </form>
        </div>
    </div>
    
    <!-- Exercise History Modal -->
    <div class="modal" id="exerciseHistoryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalExerciseHistoryName">Exercise History</h2>
                <button class="modal-close" onclick="closeModal('exerciseHistoryModal')">&times;</button>
            </div>
            <div class="history-chart">
                <canvas id="exerciseHistoryChart"></canvas>
            </div>
            <div id="exerciseHistoryList" style="margin-top: 24px;">
                <!-- Exercise history list will be rendered here -->
            </div>
        </div>
    </div>
    
    <!-- Google Sheets Setup Modal -->
    <div class="modal" id="googleSheetsSetupModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 class="modal-title">üìö Google Sheets Setup Guide</h2>
                <button class="modal-close" onclick="closeModal('googleSheetsSetupModal')">&times;</button>
            </div>
            <div style="line-height: 1.8; color: var(--color-text);">
                <h3 style="margin: 24px 0 16px 0; font-size: 20px; color: var(--color-primary);">Step 1: Create a Google Sheet</h3>
                <ol style="margin-left: 20px;">
                    <li style="margin-bottom: 12px;">Go to <a href="https://sheets.google.com" target="_blank" style="color: var(--color-primary); text-decoration: underline;">sheets.google.com</a></li>
                    <li style="margin-bottom: 12px;">Create a new blank spreadsheet</li>
                    <li style="margin-bottom: 12px;">Name it "Fit Trackr Pro Data"</li>
                    <li style="margin-bottom: 12px;">Create three sheets: <strong>Workouts</strong>, <strong>Metrics</strong>, and <strong>Exercises</strong></li>
                </ol>
                
                <h3 style="margin: 24px 0 16px 0; font-size: 20px; color: var(--color-primary);">Step 2: Create Google Apps Script</h3>
                <ol style="margin-left: 20px;">
                    <li style="margin-bottom: 12px;">In your Google Sheet, go to <strong>Extensions ‚Üí Apps Script</strong></li>
                    <li style="margin-bottom: 12px;">Delete any code and paste this script:</li>
                </ol>
                
                <pre style="background: var(--color-bg); padding: 16px; border-radius: var(--radius-sm); overflow-x: auto; font-size: 12px; margin: 16px 0;"><code>// Add this SHEET_ID at the top - replace with your actual Sheet ID
const SHEET_ID = 'YOUR_SHEET_ID_HERE'; // Get from Sheet URL

function doPost(e) {
  // Open specific sheet by ID (requires no Drive access)
  const sheet = SpreadsheetApp.openById(SHEET_ID);
  const data = JSON.parse(e.postData.contents);
  
  if (data.type === 'workouts') {
    const ws = sheet.getSheetByName('Workouts');
    ws.clear();
    ws.appendRow(['Date', 'Exercise', 'Muscle', 'Sets', 'Reps', 'Weight', 'Duration']);
    data.workouts.forEach(w => {
      w.exercises.forEach(ex => {
        ws.appendRow([w.date, ex.name, ex.muscle, ex.sets || '', ex.reps || '', ex.weight || '', ex.duration || '']);
      });
    });
  } else if (data.type === 'metrics') {
    const ms = sheet.getSheetByName('Metrics');
    ms.clear();
    ms.appendRow(['Date', 'Weight', 'Body Fat %', 'BMI']);
    data.metrics.forEach(m => {
      ms.appendRow([m.date, m.weight || '', m.bodyFat || '', m.bmi || '']);
    });
  } else if (data.type === 'exercises') {
    const es = sheet.getSheetByName('Exercises');
    es.clear();
    es.appendRow(['Name', 'Primary Muscle', 'Secondary', 'Equipment', 'Videos']);
    data.exercises.forEach(ex => {
      es.appendRow([ex.name, ex.primary, ex.secondary, ex.equipment, ex.videos]);
    });
  }
  
  return ContentService.createTextOutput(JSON.stringify({success: true}));
}

function doGet(e) {
  // Open specific sheet by ID (requires no Drive access)
  const sheet = SpreadsheetApp.openById(SHEET_ID);
  const type = e.parameter.type;
  
  if (type === 'workouts') {
    const ws = sheet.getSheetByName('Workouts');
    const data = ws.getDataRange().getValues();
    return ContentService.createTextOutput(JSON.stringify({workouts: data}));
  } else if (type === 'metrics') {
    const ms = sheet.getSheetByName('Metrics');
    const data = ms.getDataRange().getValues();
    return ContentService.createTextOutput(JSON.stringify({metrics: data}));
  } else if (type === 'exercises') {
    const es = sheet.getSheetByName('Exercises');
    const data = es.getDataRange().getValues();
    return ContentService.createTextOutput(JSON.stringify({exercises: data}));
  }
  
  return ContentService.createTextOutput(JSON.stringify({error: 'Invalid type'}));
}</code></pre>
                
                <h3 style="margin: 24px 0 16px 0; font-size: 20px; color: var(--color-primary);">Step 3: Get Your Sheet ID</h3>
                <ol style="margin-left: 20px;">
                    <li style="margin-bottom: 12px;">Look at your Google Sheet URL</li>
                    <li style="margin-bottom: 12px;">Copy the ID between <code>/d/</code> and <code>/edit</code></li>
                    <li style="margin-bottom: 12px;">Example: <code>https://docs.google.com/spreadsheets/d/<strong>1ABC...XYZ</strong>/edit</code></li>
                    <li style="margin-bottom: 12px;">Replace <code>YOUR_SHEET_ID_HERE</code> in the script with your ID</li>
                </ol>
                
                <h3 style="margin: 24px 0 16px 0; font-size: 20px; color: var(--color-primary);">Step 4: Deploy as Web App</h3>
                <ol style="margin-left: 20px;">
                    <li style="margin-bottom: 12px;">Click <strong>Deploy ‚Üí New deployment</strong></li>
                    <li style="margin-bottom: 12px;">Select type: <strong>Web app</strong></li>
                    <li style="margin-bottom: 12px;">Execute as: <strong>Me</strong></li>
                    <li style="margin-bottom: 12px;">Who has access: <strong>Anyone</strong></li>
                    <li style="margin-bottom: 12px;">Click <strong>Deploy</strong></li>
                    <li style="margin-bottom: 12px;">‚ö†Ô∏è <strong>Important:</strong> Authorize only <strong>this specific spreadsheet</strong> (not all Drive files)</li>
                    <li style="margin-bottom: 12px;">Copy the <strong>Web app URL</strong></li>
                    <li style="margin-bottom: 12px;">Paste it in the Settings page above</li>
                </ol>
                
                <h3 style="margin: 24px 0 16px 0; font-size: 20px; color: var(--color-primary);">Step 5: Test the Connection</h3>
                <ol style="margin-left: 20px;">
                    <li style="margin-bottom: 12px;">Click <strong>Save URL</strong> in Settings</li>
                    <li style="margin-bottom: 12px;">Click <strong>Sync Now</strong></li>
                    <li style="margin-bottom: 12px;">Check your Google Sheet - data should appear!</li>
                </ol>
                
                <div style="background: rgba(78, 205, 196, 0.1); padding: 16px; border-radius: var(--radius-sm); border: 2px solid var(--color-primary); margin-top: 24px;">
                    <strong style="color: var(--color-primary);">‚úÖ That's it!</strong> Your data will now sync automatically across all your devices.
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add New Exercise Modal -->
    <div class="modal" id="addExerciseModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add New Exercise</h2>
                <button class="modal-close" onclick="closeModal('addExerciseModal')">&times;</button>
            </div>
            <form class="kpi-form" onsubmit="saveNewExercise(event)">
                <div class="form-group">
                    <label class="form-label">Exercise Name</label>
                    <input type="text" class="form-input" id="newExerciseName" required>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Primary Muscle</label>
                        <select class="metric-select" id="newExercisePrimaryMuscle" required>
                            <option value="">Select Muscle</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Equipment</label>
                        <select class="metric-select" id="newExerciseEquipment" required>
                            <option value="">Select Equipment</option>
                            <option value="Barbell">Barbell</option>
                            <option value="Dumbbell">Dumbbell</option>
                            <option value="Cable">Cable</option>
                            <option value="Machine">Machine</option>
                            <option value="Resistance Band">Resistance Band</option>
                            <option value="Body Weight">Body Weight</option>
                            <option value="Treadmill">Treadmill</option>
                            <option value="Pool">Pool</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Secondary Muscles (comma separated)</label>
                    <input type="text" class="form-input" id="newExerciseSecondaryMuscles" placeholder="e.g., Biceps, Triceps">
                </div>
                
                <div class="form-group">
                    <label class="form-label">KPI Types</label>
                    <div style="display: flex; gap: 16px; flex-wrap: wrap; margin-top: 8px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" name="kpiType" value="sets" style="width: 20px; height: 20px;">
                            <span>Sets</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" name="kpiType" value="reps" style="width: 20px; height: 20px;">
                            <span>Reps</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" name="kpiType" value="weight" style="width: 20px; height: 20px;">
                            <span>Weight</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" name="kpiType" value="duration" style="width: 20px; height: 20px;">
                            <span>Duration</span>
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">YouTube Video URLs (one per line)</label>
                    <textarea class="form-input" id="newExerciseVideos" rows="4" placeholder="https://www.youtube.com/watch?v=...&#10;https://www.youtube.com/watch?v=..." style="resize: vertical; font-family: inherit;"></textarea>
                    <div style="font-size: 12px; color: var(--color-text-muted); margin-top: 4px;">
                        Enter full YouTube URLs or embed URLs
                    </div>
                </div>
                
                <button type="submit" class="form-submit">Add Exercise</button>
            </form>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // App State
        const appState = {
            currentView: 'dashboard',
            currentMonth: new Date(2025, 9, 1),
            bodyView: 'front',
            selectedMetric: 'weight',
            userHeight: 180.34, // 5'11" in cm
            googleSheetsUrl: '', // User will configure this
            isSyncing: false,
            
            muscleGroups: ['Chest', 'Back', 'Legs', 'Glutes', 'Shoulders', 'Biceps', 'Triceps', 'Forearms', 'Core'],
            
            muscleColors: {
                'Chest': '#FF6B9D',
                'Back': '#4ECDC4',
                'Legs': '#FFD93D',
                'Glutes': '#95E1D3',
                'Shoulders': '#FF8C42',
                'Biceps': '#6C5CE7',
                'Triceps': '#A29BFE',
                'Forearms': '#74B9FF',
                'Core': '#55EFC4'
            },
            
            exercises: [
                // Chest Exercises
                { name: 'Push Up', muscles_primary: 'Chest', muscles_secondary: ['Triceps', 'Shoulders'], equipment: 'Body Weight', videos: ['https://www.youtube.com/embed/IODxDxX7oi4', 'https://www.youtube.com/embed/_l3ySVKYVJ8'], kpiType: ['sets', 'reps'] },
                { name: 'Barbell Bench Press', muscles_primary: 'Chest', muscles_secondary: ['Triceps', 'Shoulders'], equipment: 'Barbell', videos: ['https://www.youtube.com/embed/vthMCtgVtFw', 'https://www.youtube.com/embed/rT7DgCr-3pg'], kpiType: ['sets', 'reps', 'weight'] },
                { name: 'Incline Dumbbell Press', muscles_primary: 'Chest', muscles_secondary: ['Shoulders', 'Triceps'], equipment: 'Dumbbell', videos: ['https://www.youtube.com/embed/8iPEnn-ltC8'], kpiType: ['sets', 'reps', 'weight'] },
                { name: 'Decline Bench Press', muscles_primary: 'Chest', muscles_secondary: ['Triceps'], equipment: 'Barbell', videos: ['https://www.youtube.com/embed/LfyQBUKR8SE'], kpiType: ['sets', 'reps', 'weight'] },
                { name: 'Cable Chest Fly', muscles_primary: 'Chest', muscles_secondary: ['Shoulders'], equipment: 'Cable', videos: ['https://www.youtube.com/embed/Iwe6AmxVf7o'], kpiType: ['sets', 'reps', 'weight'] },
                { name: 'Dumbbell Chest Fly', muscles_primary: 'Chest', muscles_secondary: [], equipment: 'Dumbbell', videos: ['https://www.youtube.com/embed/eozdVDA78K0'], kpiType: ['sets', 'reps', 'weight'] },
                { name: 'Chest Press Machine', muscles_primary: 'Chest', muscles_secondary: ['Triceps'], equipment: 'Machine', videos: ['https://www.youtube.com/embed/xUm0BiZCWlQ'], kpiType: ['sets', 'reps', 'weight'] },
                { name: 'Pec Deck Fly', muscles_primary: 'Chest', muscles_secondary: [], equipment: 'Machine', videos: ['https://www.youtube.com/embed/Z71bZor_7CE'], kpiType: ['sets', 'reps', 'weight'] },
                
                // Biceps Exercises
                { name: 'Dumbbell Curl', muscles_primary: 'Biceps', muscles_secondary: ['Forearms'], equipment: 'Dumbbell', videos: ['https://www.youtube.com/embed/ykJmrZ5v0Oo'], kpiType: ['sets', 'reps', 'weight'] },
                { name: 'Hammer Curl', muscles_primary: 'Biceps', muscles_secondary: ['Forearms'], equipment: 'Dumbbell', videos: ['https://www.youtube.com/embed/zC3nLlEvin4'], kpiType: ['sets', 'reps', 'weight'] },
                { name: 'Cable Bicep Curl', muscles_primary: 'Biceps', muscles_secondary: [], equipment: 'Cable', videos: ['https://www.youtube.com/embed/JB3IEkTcS1c'], kpiType: ['sets', 'reps', 'weight'] },
                { name: 'Preacher Curl', muscles_primary: 'Biceps', muscles_secondary: [], equipment: 'Barbell', videos: ['https://www.youtube.com/embed/fIWP-FRFNU0'], kpiType: ['sets', 'reps', 'weight'] },
                { name: 'Concentration Curl', muscles_primary: 'Biceps', muscles_secondary: [], equipment: 'Dumbbell', videos: ['https://www.youtube.com/embed/0AUGkch3tzc'], kpiType: ['sets', 'reps', 'weight'] },
                { name: 'EZ Bar Curl', muscles_primary: 'Biceps', muscles_secondary: ['Forearms'], equipment: 'Barbell', videos: ['https://www.youtube.com/embed/kwG2ipFRgfo'], kpiType: ['sets', 'reps', 'weight'] },
                { name: 'Incline Dumbbell Curl', muscles_primary: 'Biceps', muscles_secondary: [], equipment: 'Dumbbell', videos: ['https://www.youtube.com/embed/soxrZlIl35U'], kpiType: ['sets', 'reps', 'weight'] },
                
                // Back Exercises
                { name: 'Lat Pulldown', muscles_primary: 'Back', muscles_secondary: ['Biceps'], equipment: 'Cable', videos: ['https://www.youtube.com/embed/CAwf7n6Luuc'], kpiType: ['sets', 'reps', 'weight'] },
                { name: 'Resistance Band Row', muscles_primary: 'Back', muscles_secondary: ['Biceps', 'Shoulders'], equipment: 'Resistance Band', videos: ['https://www.youtube.com/embed/_Y4hQ8FtyF0'], kpiType: ['sets', 'reps'] },
                { name: 'Deadlift', muscles_primary: 'Back', muscles_secondary: ['Legs', 'Core'], equipment: 'Barbell', videos: ['https://www.youtube.com/embed/r4MzxtBKyNE'], kpiType: ['sets', 'reps', 'weight'] },
                { name: 'Seated Cable Row', muscles_primary: 'Back', muscles_secondary: ['Biceps'], equipment: 'Cable', videos: ['https://www.youtube.com/embed/UCXxvVItLoM'], kpiType: ['sets', 'reps', 'weight'] },
                { name: 'Dumbbell Row', muscles_primary: 'Back', muscles_secondary: ['Biceps'], equipment: 'Dumbbell', videos: ['https://www.youtube.com/embed/pYcpY20QaE8'], kpiType: ['sets', 'reps', 'weight'] },
                { name: 'Pull Up', muscles_primary: 'Back', muscles_secondary: ['Biceps'], equipment: 'Body Weight', videos: ['https://www.youtube.com/embed/eGo4IYlbE5g'], kpiType: ['sets', 'reps'] },
                { name: 'Barbell Row', muscles_primary: 'Back', muscles_secondary: ['Biceps'], equipment: 'Barbell', videos: ['https://www.youtube.com/embed/FWJR5Ve8bnQ'], kpiType: ['sets', 'reps', 'weight'] },
                { name: 'T-Bar Row', muscles_primary: 'Back', muscles_secondary: ['Biceps'], equipment: 'Barbell', videos: ['https://www.youtube.com/embed/j3Igk5nyZE4'], kpiType: ['sets', 'reps', 'weight'] },
                { name: 'Face Pull', muscles_primary: 'Back', muscles_secondary: ['Shoulders'], equipment: 'Cable', videos: ['https://www.youtube.com/embed/rep-qVOkqgk'], kpiType: ['sets', 'reps', 'weight'] },
                { name: 'Chin Up', muscles_primary: 'Back', muscles_secondary: ['Biceps'], equipment: 'Body Weight', videos: ['https://www.youtube.com/embed/brhRXlOhkAM'], kpiType: ['sets', 'reps'] },
                { name: 'Inverted Row', muscles_primary: 'Back', muscles_secondary: ['Biceps'], equipment: 'Body Weight', videos: ['https://www.youtube.com/embed/hXTc1mDnZCw'], kpiType: ['sets', 'reps'] },
                
                // Leg Exercises (Quads, Hamstrings, Calves)
                { name: 'Squat', muscles_primary: 'Legs', muscles_secondary: ['Glutes', 'Core'], equipment: 'Barbell', videos: ['https://www.youtube.com/embed/aclHkVaku9U'], kpiType: ['sets', 'reps', 'weight'] },
                { name: 'Leg Press', muscles_primary: 'Legs', muscles_secondary: ['Glutes'], equipment: 'Machine', videos: ['https://www.youtube.com/embed/IZxyjW7MPJQ'], kpiType: ['sets', 'reps', 'weight'] },
                { name: 'Lunges', muscles_primary: 'Legs', muscles_secondary: ['Glutes', 'Core'], equipment: 'Body Weight', videos: ['https://www.youtube.com/embed/QOVaHwm-Q6U'], kpiType: ['sets', 'reps'] },
                { name: 'Leg Curl', muscles_primary: 'Legs', muscles_secondary: [], equipment: 'Machine', videos: ['https://www.youtube.com/embed/1Tq3QdYUuHs'], kpiType: ['sets', 'reps', 'weight'] },
                { name: 'Leg Extension', muscles_primary: 'Legs', muscles_secondary: [], equipment: 'Machine', videos: ['https://www.youtube.com/embed/YyvSfVjQeL0'], kpiType: ['sets', 'reps', 'weight'] },
                { name: 'Calf Raise', muscles_primary: 'Legs', muscles_secondary: [], equipment: 'Body Weight', videos: ['https://www.youtube.com/embed/-M4-G8p8fmc'], kpiType: ['sets', 'reps'] },
                { name: 'Resistance Band Glute Bridge', muscles_primary: 'Glutes', muscles_secondary: ['Core'], equipment: 'Resistance Band', videos: ['https://www.youtube.com/embed/pB4m2gzSdfI'], kpiType: ['sets', 'reps'] },
                { name: 'Hip Thrust', muscles_primary: 'Glutes', muscles_secondary: ['Legs'], equipment: 'Barbell', videos: ['https://www.youtube.com/embed/SEdqd1n0cvg'], kpiType: ['sets', 'reps', 'weight'] },
                { name: 'Glute Bridge', muscles_primary: 'Glutes', muscles_secondary: ['Legs'], equipment: 'Body Weight', videos: ['https://www.youtube.com/embed/wPM8icPu6H8'], kpiType: ['sets', 'reps'] },
                { name: 'Cable Glute Kickback', muscles_primary: 'Glutes', muscles_secondary: [], equipment: 'Cable', videos: ['https://www.youtube.com/embed/4RTRCJqVlJY'], kpiType: ['sets', 'reps', 'weight'] },
                { name: 'Single Leg Glute Bridge', muscles_primary: 'Glutes', muscles_secondary: ['Core'], equipment: 'Body Weight', videos: ['https://www.youtube.com/embed/AVAXiy6a2rE'], kpiType: ['sets', 'reps'] },
                { name: 'Sumo Deadlift', muscles_primary: 'Glutes', muscles_secondary: ['Legs', 'Back'], equipment: 'Barbell', videos: ['https://www.youtube.com/embed/kQj7VlPxnjw'], kpiType: ['sets', 'reps', 'weight'] },
                { name: 'Glute Kickback Machine', muscles_primary: 'Glutes', muscles_secondary: [], equipment: 'Machine', videos: ['https://www.youtube.com/embed/ECV7_RER6RI'], kpiType: ['sets', 'reps', 'weight'] },
                
                // Shoulder Exercises
                { name: 'Overhead Press', muscles_primary: 'Shoulders', muscles_secondary: ['Triceps'], equipment: 'Barbell', videos: ['https://www.youtube.com/embed/2yjwXTZQDDI'], kpiType: ['sets', 'reps', 'weight'] },
                { name: 'Dumbbell Shoulder Press', muscles_primary: 'Shoulders', muscles_secondary: ['Triceps'], equipment: 'Dumbbell', videos: ['https://www.youtube.com/embed/qEwKCR5JCog'], kpiType: ['sets', 'reps', 'weight'] },
                { name: 'Lateral Raise', muscles_primary: 'Shoulders', muscles_secondary: [], equipment: 'Dumbbell', videos: ['https://www.youtube.com/embed/3VcKaXpzqRo'], kpiType: ['sets', 'reps', 'weight'] },
                { name: 'Front Raise', muscles_primary: 'Shoulders', muscles_secondary: [], equipment: 'Dumbbell', videos: ['https://www.youtube.com/embed/YE9tr7stP4k'], kpiType: ['sets', 'reps', 'weight'] },
                { name: 'Rear Delt Fly', muscles_primary: 'Shoulders', muscles_secondary: ['Back'], equipment: 'Dumbbell', videos: ['https://www.youtube.com/embed/6yMdhi2DVao'], kpiType: ['sets', 'reps', 'weight'] },
                { name: 'Arnold Press', muscles_primary: 'Shoulders', muscles_secondary: ['Triceps'], equipment: 'Dumbbell', videos: ['https://www.youtube.com/embed/6Z15_WdXmVw'], kpiType: ['sets', 'reps', 'weight'] },
                { name: 'Cable Lateral Raise', muscles_primary: 'Shoulders', muscles_secondary: [], equipment: 'Cable', videos: ['https://www.youtube.com/embed/PPrzBWZDOhA'], kpiType: ['sets', 'reps', 'weight'] },
                { name: 'Upright Row', muscles_primary: 'Shoulders', muscles_secondary: ['Biceps'], equipment: 'Barbell', videos: ['https://www.youtube.com/embed/UW_ZJkPvRW0'], kpiType: ['sets', 'reps', 'weight'] },
                
                // Triceps Exercises
                { name: 'Cable Tricep Pushdown', muscles_primary: 'Triceps', muscles_secondary: ['Shoulders'], equipment: 'Cable', videos: ['https://www.youtube.com/embed/2-LAMcpzODU'], kpiType: ['sets', 'reps', 'weight'] },
                { name: 'Dumbbell Tricep Extension', muscles_primary: 'Triceps', muscles_secondary: [], equipment: 'Dumbbell', videos: ['https://www.youtube.com/embed/ir5PsbniVSc'], kpiType: ['sets', 'reps', 'weight'] },
                { name: 'Skull Crusher', muscles_primary: 'Triceps', muscles_secondary: [], equipment: 'Barbell', videos: ['https://www.youtube.com/embed/d_KZxkY_0cM'], kpiType: ['sets', 'reps', 'weight'] },
                { name: 'Dips', muscles_primary: 'Triceps', muscles_secondary: ['Chest', 'Shoulders'], equipment: 'Body Weight', videos: ['https://www.youtube.com/embed/2z8JmcrW-As'], kpiType: ['sets', 'reps'] },
                { name: 'Barbell Wrist Curl', muscles_primary: 'Forearms', muscles_secondary: [], equipment: 'Barbell', videos: ['https://www.youtube.com/embed/nFG4qkDgPUE'], kpiType: ['sets', 'reps', 'weight'] },
                { name: 'Reverse Wrist Curl', muscles_primary: 'Forearms', muscles_secondary: [], equipment: 'Barbell', videos: ['https://www.youtube.com/embed/lwJW2dRZhGw'], kpiType: ['sets', 'reps', 'weight'] },
                { name: 'Wrist Roller', muscles_primary: 'Forearms', muscles_secondary: [], equipment: 'Body Weight', videos: ['https://www.youtube.com/embed/hTBb0OssaFw'], kpiType: ['sets', 'reps'] },
                { name: 'Farmer Walk', muscles_primary: 'Forearms', muscles_secondary: ['Core'], equipment: 'Dumbbell', videos: ['https://www.youtube.com/embed/rt14nQLm54Y'], kpiType: ['duration', 'weight'] },
                
                // Core/Abs Exercises
                { name: 'Plank', muscles_primary: 'Core', muscles_secondary: ['Shoulders'], equipment: 'Body Weight', videos: ['https://www.youtube.com/embed/pSHjTRCQxIw'], kpiType: ['duration'] },
                { name: 'Russian Twist', muscles_primary: 'Core', muscles_secondary: [], equipment: 'Body Weight', videos: ['https://www.youtube.com/embed/wkD8rjkodUI'], kpiType: ['sets', 'reps'] },
                { name: 'Hanging Leg Raise', muscles_primary: 'Core', muscles_secondary: [], equipment: 'Body Weight', videos: ['https://www.youtube.com/embed/hdng3Nm1x_E'], kpiType: ['sets', 'reps'] },
                { name: 'Cable Crunch', muscles_primary: 'Core', muscles_secondary: [], equipment: 'Cable', videos: ['https://www.youtube.com/embed/Kqe1wF_OuJA'], kpiType: ['sets', 'reps', 'weight'] },
                { name: 'Bicycle Crunch', muscles_primary: 'Core', muscles_secondary: [], equipment: 'Body Weight', videos: ['https://www.youtube.com/embed/9FGilxCbdz8'], kpiType: ['sets', 'reps'] },
                { name: 'Leg Raises', muscles_primary: 'Core', muscles_secondary: [], equipment: 'Body Weight', videos: ['https://www.youtube.com/embed/JB2oyawG9KI'], kpiType: ['sets', 'reps'] },
                { name: 'Ab Wheel Rollout', muscles_primary: 'Core', muscles_secondary: ['Back'], equipment: 'Body Weight', videos: ['https://www.youtube.com/embed/EXm1AwUxNzM'], kpiType: ['sets', 'reps'] },
                { name: 'Dead Bug', muscles_primary: 'Core', muscles_secondary: [], equipment: 'Body Weight', videos: ['https://www.youtube.com/embed/g_BYB0R-4Ws'], kpiType: ['sets', 'reps'] },
                { name: 'Side Plank', muscles_primary: 'Core', muscles_secondary: [], equipment: 'Body Weight', videos: ['https://www.youtube.com/embed/K2VljzCC16g'], kpiType: ['duration'] },
                { name: 'Oblique Crunch', muscles_primary: 'Core', muscles_secondary: [], equipment: 'Body Weight', videos: ['https://www.youtube.com/embed/Mfp9Y7MtVbY'], kpiType: ['sets', 'reps'] },
                { name: 'Cable Woodchop', muscles_primary: 'Core', muscles_secondary: ['Shoulders'], equipment: 'Cable', videos: ['https://www.youtube.com/embed/pAplQXk3dkU'], kpiType: ['sets', 'reps', 'weight'] },
                { name: 'Mountain Climbers', muscles_primary: 'Core', muscles_secondary: ['Shoulders'], equipment: 'Body Weight', videos: ['https://www.youtube.com/embed/nmwgirgXLYM'], kpiType: ['duration'] },
                { name: 'Burpees', muscles_primary: 'Core', muscles_secondary: ['Chest', 'Legs'], equipment: 'Body Weight', videos: ['https://www.youtube.com/embed/dZgVxmf6jkA'], kpiType: ['sets', 'reps'] },
                
                // Cardio Exercises
                { name: 'Treadmill Running', muscles_primary: 'Legs', muscles_secondary: ['Core'], equipment: 'Treadmill', videos: ['https://www.youtube.com/embed/Mh1Uz8-3MlM', 'https://www.youtube.com/embed/e4u7zNvxe6Y'], kpiType: ['duration'] },
                { name: 'Outdoor Running', muscles_primary: 'Legs', muscles_secondary: ['Core'], equipment: 'Body Weight', videos: ['https://www.youtube.com/embed/brFHyOtTwH4', 'https://www.youtube.com/embed/RKHnj5S77Kw'], kpiType: ['duration'] },
                { name: 'Sprinting', muscles_primary: 'Legs', muscles_secondary: ['Core'], equipment: 'Body Weight', videos: ['https://www.youtube.com/embed/o0Nn2oJrLl4', 'https://www.youtube.com/embed/GY3pWKkeHhY'], kpiType: ['duration'] },
                { name: 'Skipping', muscles_primary: 'Legs', muscles_secondary: ['Core', 'Shoulders'], equipment: 'Body Weight', videos: ['https://www.youtube.com/embed/1BZMwQ3c8LM', 'https://www.youtube.com/embed/hCZ22f6c_bE'], kpiType: ['duration'] },
                { name: 'Swimming', muscles_primary: 'Back', muscles_secondary: ['Shoulders', 'Core'], equipment: 'Pool', videos: ['https://www.youtube.com/embed/5HLW2AI1Ink', 'https://www.youtube.com/embed/w4JkmXXMhGk'], kpiType: ['duration'] },
                { name: 'Rowing Machine', muscles_primary: 'Back', muscles_secondary: ['Legs', 'Core'], equipment: 'Machine', videos: ['https://www.youtube.com/embed/4dMJt0jfFPI', 'https://www.youtube.com/embed/zF5jU1bDIJo'], kpiType: ['duration'] },
                { name: 'Stair Climber', muscles_primary: 'Legs', muscles_secondary: ['Glutes'], equipment: 'Machine', videos: ['https://www.youtube.com/embed/hT-JY85i67U', 'https://www.youtube.com/embed/7RyNjlVJUu0'], kpiType: ['duration'] },
                { name: 'Elliptical', muscles_primary: 'Legs', muscles_secondary: ['Core'], equipment: 'Machine', videos: ['https://www.youtube.com/embed/pQfn6gvYdV0', 'https://www.youtube.com/embed/W0s4GbwLqls'], kpiType: ['duration'] }
            ],
            
            workouts: [],
            
            metrics: [],
            
            charts: {
                metrics: null,
                exerciseHistory: null
            }
        };
        
        // Navigation
        function switchView(view) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            document.getElementById(view).classList.add('active');
            event.target.closest('.nav-item').classList.add('active');
            
            appState.currentView = view;
            
            if (view === 'exercises') {
                renderExerciseLibrary();
            }
        }
        
        function switchViewMobile(view) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.bottom-nav-item').forEach(n => n.classList.remove('active'));
            
            document.getElementById(view).classList.add('active');
            event.target.closest('.bottom-nav-item').classList.add('active');
            
            appState.currentView = view;
            
            if (view === 'exercises') {
                renderExerciseLibrary();
            }
        }
        
        // Calendar Functions
        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const monthEl = document.getElementById('calendarMonth');
            
            const year = appState.currentMonth.getFullYear();
            const month = appState.currentMonth.getMonth();
            
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                              'July', 'August', 'September', 'October', 'November', 'December'];
            monthEl.textContent = `${monthNames[month]} ${year}`;
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            grid.innerHTML = '';
            
            // Day headers
            ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-day-header';
                header.textContent = day;
                grid.appendChild(header);
            });
            
            // Empty cells
            for (let i = 0; i < firstDay; i++) {
                const empty = document.createElement('div');
                grid.appendChild(empty);
            }
            
            // Days
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const workout = appState.workouts.find(w => w.date === dateStr);
                
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day';
                if (workout) dayEl.classList.add('has-workout');
                
                const number = document.createElement('div');
                number.className = 'calendar-day-number';
                number.textContent = day;
                dayEl.appendChild(number);
                
                if (workout) {
                    const dots = document.createElement('div');
                    dots.className = 'calendar-day-dots';
                    
                    const muscleGroups = getWorkoutMuscleGroups(workout);
                    muscleGroups.forEach(muscle => {
                        const dot = document.createElement('div');
                        dot.className = 'muscle-dot';
                        dot.style.backgroundColor = appState.muscleColors[muscle];
                        dots.appendChild(dot);
                    });
                    
                    dayEl.appendChild(dots);
                    dayEl.onclick = () => showWorkoutDetail(dateStr);
                }
                
                grid.appendChild(dayEl);
            }
            
            updateStats();
        }
        
        function changeMonth(delta) {
            appState.currentMonth = new Date(
                appState.currentMonth.getFullYear(),
                appState.currentMonth.getMonth() + delta,
                1
            );
            renderCalendar();
        }
        
        function getWorkoutMuscleGroups(workout) {
            const muscles = new Set();
            workout.exercises.forEach(ex => {
                const exercise = appState.exercises.find(e => e.name === ex.name);
                if (exercise) {
                    muscles.add(exercise.muscles_primary);
                }
            });
            return Array.from(muscles);
        }
        
        function showWorkoutDetail(dateStr) {
            const workout = appState.workouts.find(w => w.date === dateStr);
            if (!workout) return;
            
            const date = new Date(dateStr + 'T00:00:00');
            const formattedDate = date.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            document.getElementById('modalWorkoutDate').textContent = formattedDate;
            
            let html = '<div class="stats-grid">';
            html += `<div class="stat-card"><div class="stat-value">${workout.exercises.length}</div><div class="stat-label">Exercises</div></div>`;
            
            const totalSets = workout.exercises.reduce((sum, ex) => sum + (ex.sets || 0), 0);
            html += `<div class="stat-card"><div class="stat-value">${totalSets}</div><div class="stat-label">Total Sets</div></div>`;
            
            const muscles = getWorkoutMuscleGroups(workout);
            html += `<div class="stat-card"><div class="stat-value">${muscles.length}</div><div class="stat-label">Muscle Groups</div></div>`;
            html += '</div>';
            
            html += '<h3 style="margin: 24px 0 16px 0; font-size: 20px;">Exercises</h3>';
            
            workout.exercises.forEach(ex => {
                const exercise = appState.exercises.find(e => e.name === ex.name);
                let details = '';
                
                if (ex.sets && ex.reps && ex.weight) {
                    details = `${ex.sets} sets √ó ${ex.reps} reps @ ${ex.weight}kg`;
                } else if (ex.sets && ex.reps) {
                    details = `${ex.sets} sets √ó ${ex.reps} reps`;
                } else if (ex.duration) {
                    details = `${ex.duration} min`;
                }
                
                html += `
                    <div class="exercise-log">
                        <div class="exercise-log-header">
                            <div class="exercise-log-name">${ex.name}</div>
                            <div style="color: ${appState.muscleColors[exercise?.muscles_primary]}; font-weight: 700;">
                                ${exercise?.muscles_primary}
                            </div>
                        </div>
                        <div class="exercise-log-details">${details}</div>
                    </div>
                `;
            });
            
            document.getElementById('workoutDetailContent').innerHTML = html;
            document.getElementById('workoutModal').classList.add('active');
        }
        
        // Body Map Functions - Removed (now just muscle stats)
        function renderBodyMap() {
            // Body map removed, only showing muscle stats
            renderMuscleStats();
        }
        
        function renderBodyMapOld() {
            const container = document.getElementById('bodySvgContainer');
            
            // SVG based on the uploaded image structure
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('viewBox', '0 0 400 600');
            svg.setAttribute('id', 'bodySvg');
            svg.style.maxWidth = '400px';
            
            if (appState.bodyView === 'front') {
                // Front view - simplified anatomical structure
                
                // Head
                const head = createMuscleGroup('ellipse', { cx: 200, cy: 40, rx: 30, ry: 40 }, 'Shoulders', 'head');
                
                // Chest/Pectorals
                const chest = createMuscleGroup('path', {
                    d: 'M 170 90 Q 150 110, 160 140 L 170 150 L 200 155 L 230 150 L 240 140 Q 250 110, 230 90 Z'
                }, 'Chest', 'chest');
                
                // Core/Abs
                const core = createMuscleGroup('rect', {
                    x: 175, y: 155, width: 50, height: 90, rx: 10
                }, 'Core', 'core');
                
                // Shoulders (Deltoids)
                const leftShoulder = createMuscleGroup('ellipse', {
                    cx: 140, cy: 100, rx: 25, ry: 35, transform: 'rotate(-20 140 100)'
                }, 'Shoulders', 'shoulders');
                
                const rightShoulder = createMuscleGroup('ellipse', {
                    cx: 260, cy: 100, rx: 25, ry: 35, transform: 'rotate(20 260 100)'
                }, 'Shoulders', 'shoulders');
                
                // Biceps
                const leftBicep = createMuscleGroup('ellipse', {
                    cx: 130, cy: 170, rx: 15, ry: 35
                }, 'Biceps', 'biceps');
                
                const rightBicep = createMuscleGroup('ellipse', {
                    cx: 270, cy: 170, rx: 15, ry: 35
                }, 'Biceps', 'biceps');
                
                // Forearms
                const leftForearm = createMuscleGroup('path', {
                    d: 'M 125 205 L 120 260 L 130 260 L 135 205 Z'
                }, 'Forearms', 'forearms');
                
                const rightForearm = createMuscleGroup('path', {
                    d: 'M 275 205 L 280 260 L 270 260 L 265 205 Z'
                }, 'Forearms', 'forearms');
                
                // Legs (Quadriceps)
                const leftLeg = createMuscleGroup('path', {
                    d: 'M 175 250 L 170 400 L 185 400 L 190 250 Z'
                }, 'Legs', 'legs');
                
                const rightLeg = createMuscleGroup('path', {
                    d: 'M 225 250 L 220 400 L 235 400 L 240 250 Z'
                }, 'Legs', 'legs');
                
                // Calves
                const leftCalf = createMuscleGroup('ellipse', {
                    cx: 177, cy: 480, rx: 12, ry: 50
                }, 'Legs', 'legs');
                
                const rightCalf = createMuscleGroup('ellipse', {
                    cx: 228, cy: 480, rx: 12, ry: 50
                }, 'Legs', 'legs');
                
                svg.appendChild(head);
                svg.appendChild(chest);
                svg.appendChild(core);
                svg.appendChild(leftShoulder);
                svg.appendChild(rightShoulder);
                svg.appendChild(leftBicep);
                svg.appendChild(rightBicep);
                svg.appendChild(leftForearm);
                svg.appendChild(rightForearm);
                svg.appendChild(leftLeg);
                svg.appendChild(rightLeg);
                svg.appendChild(leftCalf);
                svg.appendChild(rightCalf);
                
            } else {
                // Back view
                
                // Head
                const head = createMuscleGroup('ellipse', { cx: 200, cy: 40, rx: 30, ry: 40 }, 'Shoulders', 'head');
                
                // Upper Back (Trapezius)
                const upperBack = createMuscleGroup('path', {
                    d: 'M 160 70 L 150 110 L 180 120 L 200 115 L 220 120 L 250 110 L 240 70 Z'
                }, 'Back', 'back');
                
                // Mid Back (Lats)
                const lats = createMuscleGroup('path', {
                    d: 'M 150 120 Q 130 160, 145 200 L 165 210 L 200 215 L 235 210 L 255 200 Q 270 160, 250 120 Z'
                }, 'Back', 'back');
                
                // Lower Back
                const lowerBack = createMuscleGroup('rect', {
                    x: 175, y: 215, width: 50, height: 35, rx: 10
                }, 'Core', 'core');
                
                // Shoulders (Rear Delts)
                const leftShoulder = createMuscleGroup('ellipse', {
                    cx: 140, cy: 100, rx: 25, ry: 35, transform: 'rotate(-20 140 100)'
                }, 'Shoulders', 'shoulders');
                
                const rightShoulder = createMuscleGroup('ellipse', {
                    cx: 260, cy: 100, rx: 25, ry: 35, transform: 'rotate(20 260 100)'
                }, 'Shoulders', 'shoulders');
                
                // Triceps
                const leftTricep = createMuscleGroup('ellipse', {
                    cx: 130, cy: 170, rx: 15, ry: 35
                }, 'Triceps', 'triceps');
                
                const rightTricep = createMuscleGroup('ellipse', {
                    cx: 270, cy: 170, rx: 15, ry: 35
                }, 'Triceps', 'triceps');
                
                // Forearms
                const leftForearm = createMuscleGroup('path', {
                    d: 'M 125 205 L 120 260 L 130 260 L 135 205 Z'
                }, 'Forearms', 'forearms');
                
                const rightForearm = createMuscleGroup('path', {
                    d: 'M 275 205 L 280 260 L 270 260 L 265 205 Z'
                }, 'Forearms', 'forearms');
                
                // Glutes
                const glutes = createMuscleGroup('ellipse', {
                    cx: 200, cy: 270, rx: 45, ry: 30
                }, 'Glutes', 'glutes');
                
                // Hamstrings
                const leftHamstring = createMuscleGroup('path', {
                    d: 'M 175 295 L 170 390 L 185 390 L 190 295 Z'
                }, 'Legs', 'legs');
                
                const rightHamstring = createMuscleGroup('path', {
                    d: 'M 225 295 L 220 390 L 235 390 L 240 295 Z'
                }, 'Legs', 'legs');
                
                // Calves
                const leftCalf = createMuscleGroup('ellipse', {
                    cx: 177, cy: 480, rx: 12, ry: 50
                }, 'Legs', 'legs');
                
                const rightCalf = createMuscleGroup('ellipse', {
                    cx: 228, cy: 480, rx: 12, ry: 50
                }, 'Legs', 'legs');
                
                svg.appendChild(head);
                svg.appendChild(upperBack);
                svg.appendChild(lats);
                svg.appendChild(lowerBack);
                svg.appendChild(leftShoulder);
                svg.appendChild(rightShoulder);
                svg.appendChild(leftTricep);
                svg.appendChild(rightTricep);
                svg.appendChild(leftForearm);
                svg.appendChild(rightForearm);
                svg.appendChild(glutes);
                svg.appendChild(leftHamstring);
                svg.appendChild(rightHamstring);
                svg.appendChild(leftCalf);
                svg.appendChild(rightCalf);
            }
            
            container.innerHTML = '';
            container.appendChild(svg);
            
            updateMuscleMapActivity();
        }
        
        function createMuscleGroup(type, attrs, muscle, id) {
            const element = document.createElementNS('http://www.w3.org/2000/svg', type);
            
            for (let key in attrs) {
                element.setAttribute(key, attrs[key]);
            }
            
            element.classList.add('muscle-group');
            element.setAttribute('data-muscle', muscle);
            element.setAttribute('id', `muscle-${id}`);
            element.style.fill = appState.muscleColors[muscle];
            element.style.stroke = '#1a1f3a';
            element.style.strokeWidth = '2';
            
            element.onclick = () => showMuscleHistory(muscle);
            
            return element;
        }
        
        function updateMuscleMapActivity() {
            // Body map activity removed
            return;
        }
        
        function toggleBodyView(view) {
            // Body view toggle removed
            return;
        }
        
        function showAddExerciseModal(exerciseName) {
            // If exerciseName is provided, show exercise detail instead
            if (exerciseName && typeof exerciseName === 'string') {
                showExerciseDetail(exerciseName);
                return;
            }
            
            // Populate muscle groups
            const primaryMuscleSelect = document.getElementById('newExercisePrimaryMuscle');
            primaryMuscleSelect.innerHTML = '<option value="">Select Muscle</option>';
            appState.muscleGroups.forEach(muscle => {
                const option = document.createElement('option');
                option.value = muscle;
                option.textContent = muscle;
                primaryMuscleSelect.appendChild(option);
            });
            
            document.getElementById('addExerciseModal').classList.add('active');
        }
        
        function saveNewExercise(event) {
            event.preventDefault();
            
            const name = document.getElementById('newExerciseName').value.trim();
            const primaryMuscle = document.getElementById('newExercisePrimaryMuscle').value;
            const equipment = document.getElementById('newExerciseEquipment').value;
            const secondaryMusclesRaw = document.getElementById('newExerciseSecondaryMuscles').value.trim();
            const secondaryMuscles = secondaryMusclesRaw ? secondaryMusclesRaw.split(',').map(m => m.trim()).filter(m => m) : [];
            
            // Get checked KPI types
            const kpiTypeCheckboxes = document.querySelectorAll('input[name="kpiType"]:checked');
            const kpiType = Array.from(kpiTypeCheckboxes).map(cb => cb.value);
            
            if (kpiType.length === 0) {
                alert('Please select at least one KPI type');
                return;
            }
            
            // Parse video URLs
            const videoText = document.getElementById('newExerciseVideos').value.trim();
            const videoLines = videoText.split('\n').map(line => line.trim()).filter(line => line);
            const videos = videoLines.map(url => {
                // Convert regular YouTube URLs to embed URLs
                if (url.includes('youtube.com/watch?v=')) {
                    const videoId = url.split('v=')[1].split('&')[0];
                    return `https://www.youtube.com/embed/${videoId}`;
                } else if (url.includes('youtu.be/')) {
                    const videoId = url.split('youtu.be/')[1].split('?')[0];
                    return `https://www.youtube.com/embed/${videoId}`;
                } else if (url.includes('youtube.com/embed/')) {
                    return url;
                }
                return url;
            });
            
            if (videos.length === 0) {
                alert('Please add at least one video URL');
                return;
            }
            
            // Check if exercise already exists
            if (appState.exercises.find(e => e.name.toLowerCase() === name.toLowerCase())) {
                alert('An exercise with this name already exists');
                return;
            }
            
            // Create new exercise
            const newExercise = {
                name,
                muscles_primary: primaryMuscle,
                muscles_secondary: secondaryMuscles,
                equipment,
                videos,
                kpiType
            };
            
            appState.exercises.push(newExercise);
            
            // Close modal and refresh
            closeModal('addExerciseModal');
            event.target.reset();
            
            // Show success message
            alert(`Exercise "${name}" added successfully!`);
            
            // Refresh exercise library if we're on that view
            if (appState.currentView === 'exercises') {
                renderExerciseLibrary();
            }
        }
        
        function renderMuscleStats() {
            const container = document.getElementById('muscleStatsList');
            const period = document.getElementById('muscleActivityPeriod').value;
            
            let filteredWorkouts = appState.workouts;
            if (period !== 'all') {
                const days = parseInt(period);
                filteredWorkouts = appState.workouts.filter(w => {
                    const date = new Date(w.date);
                    const now = new Date();
                    const diffTime = Math.abs(now - date);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    return diffDays <= days;
                });
            }
            
            const muscleActivity = {};
            const muscleLastWorkout = {};
            appState.muscleGroups.forEach(m => {
                muscleActivity[m] = { exercises: 0, workouts: new Set() };
                muscleLastWorkout[m] = null;
            });
            
            filteredWorkouts.forEach(workout => {
                workout.exercises.forEach(ex => {
                    const exercise = appState.exercises.find(e => e.name === ex.name);
                    if (exercise) {
                        const muscle = exercise.muscles_primary;
                        muscleActivity[muscle].exercises++;
                        muscleActivity[muscle].workouts.add(workout.date);
                        
                        // Track last workout date
                        const workoutDate = new Date(workout.date);
                        if (!muscleLastWorkout[muscle] || workoutDate > new Date(muscleLastWorkout[muscle])) {
                            muscleLastWorkout[muscle] = workout.date;
                        }
                    }
                });
            });
            
            const sorted = Object.entries(muscleActivity).sort((a, b) => 
                b[1].exercises - a[1].exercises
            );
            
            let html = '';
            sorted.forEach(([muscle, activity]) => {
                const workoutCount = activity.workouts.size;
                
                let daysSince = '‚Äî';
                if (muscleLastWorkout[muscle]) {
                    const lastDate = new Date(muscleLastWorkout[muscle]);
                    const now = new Date();
                    const diffDays = Math.floor((now - lastDate) / (1000 * 60 * 60 * 24));
                    daysSince = diffDays === 0 ? 'Today' : `${diffDays}d ago`;
                }
                
                html += `
                    <div class="muscle-stat-item" onclick="showMuscleHistory('${muscle}')">
                        <div class="muscle-name">
                            <div class="muscle-color-indicator" style="background: ${appState.muscleColors[muscle]}"></div>
                            ${muscle}
                        </div>
                        <div style="display: flex; align-items: center; gap: 16px;">
                            <div style="text-align: right;">
                                <div class="muscle-value" style="font-size: 16px; margin-bottom: 2px;">${workoutCount}</div>
                                <div style="font-size: 11px; color: var(--color-text-muted);">workouts</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 14px; font-weight: 600; color: var(--color-text-muted);">${daysSince}</div>
                                <div style="font-size: 11px; color: var(--color-text-muted);">last</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function showMuscleHistory(muscle) {
            document.getElementById('modalMuscleName').textContent = `${muscle} History`;
            
            const muscleWorkouts = appState.workouts.filter(w => {
                return w.exercises.some(ex => {
                    const exercise = appState.exercises.find(e => e.name === ex.name);
                    return exercise && exercise.muscles_primary === muscle;
                });
            }).sort((a, b) => new Date(b.date) - new Date(a.date));
            
            let html = '<div class="stats-grid">';
            html += `<div class="stat-card"><div class="stat-value">${muscleWorkouts.length}</div><div class="stat-label">Total Workouts</div></div>`;
            
            const totalExercises = muscleWorkouts.reduce((sum, w) => {
                return sum + w.exercises.filter(ex => {
                    const exercise = appState.exercises.find(e => e.name === ex.name);
                    return exercise && exercise.muscles_primary === muscle;
                }).length;
            }, 0);
            
            html += `<div class="stat-card"><div class="stat-value">${totalExercises}</div><div class="stat-label">Total Exercises</div></div>`;
            
            if (muscleWorkouts.length > 0) {
                const lastWorkout = new Date(muscleWorkouts[0].date);
                const daysSince = Math.floor((new Date() - lastWorkout) / (1000 * 60 * 60 * 24));
                html += `<div class="stat-card"><div class="stat-value">${daysSince}</div><div class="stat-label">Days Since Last</div></div>`;
            }
            
            html += '</div>';
            
            html += '<h3 style="margin: 24px 0 16px 0; font-size: 20px;">Recent Workouts</h3>';
            
            muscleWorkouts.slice(0, 10).forEach(workout => {
                const date = new Date(workout.date);
                const formattedDate = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                
                const exercises = workout.exercises.filter(ex => {
                    const exercise = appState.exercises.find(e => e.name === ex.name);
                    return exercise && exercise.muscles_primary === muscle;
                });
                
                html += `
                    <div class="exercise-log">
                        <div class="exercise-log-header">
                            <div class="exercise-log-name">${formattedDate}</div>
                            <div style="color: ${appState.muscleColors[muscle]}; font-weight: 700;">
                                ${exercises.length} exercises
                            </div>
                        </div>
                        <div class="exercise-log-details">
                            ${exercises.map(ex => ex.name).join(', ')}
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('muscleHistoryContent').innerHTML = html;
            document.getElementById('muscleHistoryModal').classList.add('active');
        }
        
        // Metrics Functions
        function updateMetricChart() {
            appState.selectedMetric = document.getElementById('metricSelect').value;
            renderMetricChart();
        }
        
        function renderMetricChart() {
            const ctx = document.getElementById('metricsChart').getContext('2d');
            
            if (appState.charts.metrics) {
                appState.charts.metrics.destroy();
            }
            
            const sortedMetrics = [...appState.metrics].sort((a, b) => 
                new Date(a.date) - new Date(b.date)
            );
            
            let data, label, color;
            
            if (appState.selectedMetric === 'weight') {
                data = sortedMetrics.map(m => m.weight);
                label = 'Weight (kg)';
                color = '#4ECDC4';
            } else if (appState.selectedMetric === 'bodyFat') {
                data = sortedMetrics.map(m => m.bodyFat);
                label = 'Body Fat %';
                color = '#FF6B9D';
            } else {
                // Calculate BMI
                data = sortedMetrics.map(m => {
                    const heightM = appState.userHeight / 100;
                    return (m.weight / (heightM * heightM)).toFixed(1);
                });
                label = 'BMI';
                color = '#FFD93D';
            }
            
            const labels = sortedMetrics.map(m => {
                const date = new Date(m.date);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });
            
            appState.charts.metrics = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: data,
                        borderColor: color,
                        backgroundColor: color + '33',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        pointBackgroundColor: color,
                        pointBorderColor: '#1a1f3a',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: '#1a1f3a',
                            titleColor: '#e8eaf0',
                            bodyColor: '#e8eaf0',
                            borderColor: color,
                            borderWidth: 2,
                            padding: 12,
                            displayColors: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: {
                                color: 'rgba(78, 205, 196, 0.1)'
                            },
                            ticks: {
                                color: '#a0a8c0'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#a0a8c0'
                            }
                        }
                    }
                }
            });
        }
        
        function showAddMetricModal() {
            document.getElementById('metricDate').valueAsDate = new Date();
            updateModalBMI();
            document.getElementById('addMetricModal').classList.add('active');
        }
        
        function updateModalBMI() {
            const weight = parseFloat(document.getElementById('metricWeight').value);
            if (weight && weight > 0) {
                const heightM = appState.userHeight / 100;
                const bmi = (weight / (heightM * heightM)).toFixed(1);
                document.getElementById('modalCurrentBMI').textContent = bmi;
            } else {
                // Show latest BMI if no weight entered
                const sortedMetrics = [...appState.metrics].sort((a, b) => 
                    new Date(b.date) - new Date(a.date)
                );
                
                if (sortedMetrics.length > 0 && sortedMetrics[0].weight) {
                    const latestWeight = sortedMetrics[0].weight;
                    const heightM = appState.userHeight / 100;
                    const bmi = (latestWeight / (heightM * heightM)).toFixed(1);
                    document.getElementById('modalCurrentBMI').textContent = bmi;
                } else {
                    document.getElementById('modalCurrentBMI').textContent = '‚Äî';
                }
            }
        }
        
        function saveMetric(event) {
            event.preventDefault();
            
            const date = document.getElementById('metricDate').value;
            const weight = parseFloat(document.getElementById('metricWeight').value);
            const bodyFat = parseFloat(document.getElementById('metricBodyFat').value);
            
            const existingIndex = appState.metrics.findIndex(m => m.date === date);
            
            const metric = { date };
            if (weight) metric.weight = weight;
            if (bodyFat) metric.bodyFat = bodyFat;
            
            if (existingIndex >= 0) {
                appState.metrics[existingIndex] = { ...appState.metrics[existingIndex], ...metric };
            } else {
                appState.metrics.push(metric);
            }
            
            renderMetricChart();
            updateCurrentBMI();
            closeModal('addMetricModal');
            
            event.target.reset();
            
            // Auto-sync if enabled
            autoSyncIfEnabled();
        }
        
        function updateCurrentBMI() {
            // BMI now shown in modal only
            return;
        }
        
        // Exercise Library Functions
        function renderExerciseLibrary() {
            populateFilters();
            filterExercises();
        }
        
        function renderExerciseList() {
            populateListFilters();
            filterExerciseList();
        }
        
        function populateListFilters() {
            const muscleFilter = document.getElementById('listMuscleFilter');
            const equipmentFilter = document.getElementById('listEquipmentFilter');
            
            // Muscle groups
            muscleFilter.innerHTML = '<option value="all">All Muscle Groups</option>';
            appState.muscleGroups.forEach(muscle => {
                const option = document.createElement('option');
                option.value = muscle;
                option.textContent = muscle;
                muscleFilter.appendChild(option);
            });
            
            // Equipment types
            const equipmentTypes = [...new Set(appState.exercises.map(e => e.equipment))];
            equipmentFilter.innerHTML = '<option value="all">All Equipment</option>';
            equipmentTypes.forEach(equipment => {
                const option = document.createElement('option');
                option.value = equipment;
                option.textContent = equipment;
                equipmentFilter.appendChild(option);
            });
        }
        
        function filterExerciseList() {
            const muscleFilter = document.getElementById('listMuscleFilter').value;
            const equipmentFilter = document.getElementById('listEquipmentFilter').value;
            
            let filtered = appState.exercises;
            
            if (muscleFilter !== 'all') {
                filtered = filtered.filter(e => e.muscles_primary === muscleFilter);
            }
            
            if (equipmentFilter !== 'all') {
                filtered = filtered.filter(e => e.equipment === equipmentFilter);
            }
            
            const tbody = document.getElementById('exerciseListTable');
            tbody.innerHTML = '';
            
            filtered.forEach(exercise => {
                const history = getExerciseHistory(exercise.name);
                const hasHistory = history.length > 0;
                
                const kpiTypeText = exercise.kpiType.map(type => {
                    if (type === 'sets') return 'Sets';
                    if (type === 'reps') return 'Reps';
                    if (type === 'weight') return 'Weight';
                    if (type === 'duration') return 'Duration';
                    return type;
                }).join(', ');
                
                const row = document.createElement('tr');
                row.style.cssText = 'background: var(--color-bg); cursor: pointer; transition: all 0.3s ease;';
                row.onmouseenter = function() { this.style.background = 'var(--color-surface-hover)'; };
                row.onmouseleave = function() { this.style.background = 'var(--color-bg)'; };
                
                row.innerHTML = `
                    <td style="padding: 16px; font-weight: 700; border-radius: var(--radius-sm) 0 0 var(--radius-sm);">
                        ${exercise.name}
                    </td>
                    <td style="padding: 16px;">
                        <span style="color: ${appState.muscleColors[exercise.muscles_primary]}; font-weight: 700;">
                            ${exercise.muscles_primary}
                        </span>
                    </td>
                    <td style="padding: 16px; color: var(--color-text-muted); font-size: 14px;">
                        ${exercise.muscles_secondary.length > 0 ? exercise.muscles_secondary.join(', ') : '‚Äî'}
                    </td>
                    <td style="padding: 16px;">
                        <span style="background: var(--color-surface-hover); padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                            ${exercise.equipment}
                        </span>
                    </td>
                    <td style="padding: 16px; text-align: center; font-size: 12px; color: var(--color-text-muted);">
                        ${kpiTypeText}
                    </td>
                    <td style="padding: 16px; text-align: center;">
                        ${hasHistory ? `
                            <button class="calendar-btn" style="font-size: 12px; padding: 6px 12px;" onclick="event.stopPropagation(); showExerciseHistory('${exercise.name}')">
                                ${history.length} times
                            </button>
                        ` : `
                            <span style="color: var(--color-text-muted); font-size: 14px;">‚Äî</span>
                        `}
                    </td>
                    <td style="padding: 16px; text-align: center; border-radius: 0 var(--radius-sm) var(--radius-sm) 0;">
                        <button class="add-exercise-btn" style="font-size: 12px;" onclick="event.stopPropagation(); showAddExerciseModal('${exercise.name}')">
                            + Add
                        </button>
                    </td>
                `;
                
                row.onclick = () => showExerciseDetail(exercise.name);
                
                tbody.appendChild(row);
            });
        }
        
        function populateFilters() {
            const muscleFilter = document.getElementById('muscleFilter');
            const equipmentFilter = document.getElementById('equipmentFilter');
            
            // Muscle groups
            muscleFilter.innerHTML = '<option value="all">All Muscle Groups</option>';
            appState.muscleGroups.forEach(muscle => {
                const option = document.createElement('option');
                option.value = muscle;
                option.textContent = muscle;
                muscleFilter.appendChild(option);
            });
            
            // Equipment types
            const equipmentTypes = [...new Set(appState.exercises.map(e => e.equipment))];
            equipmentFilter.innerHTML = '<option value="all">All Equipment</option>';
            equipmentTypes.forEach(equipment => {
                const option = document.createElement('option');
                option.value = equipment;
                option.textContent = equipment;
                equipmentFilter.appendChild(option);
            });
        }
        
        function filterExercises() {
            const searchQuery = document.getElementById('exerciseSearch').value.toLowerCase();
            const muscleFilter = document.getElementById('muscleFilter').value;
            const equipmentFilter = document.getElementById('equipmentFilter').value;
            
            let filtered = appState.exercises;
            
            if (searchQuery) {
                filtered = filtered.filter(e => e.name.toLowerCase().includes(searchQuery));
            }
            
            if (muscleFilter !== 'all') {
                filtered = filtered.filter(e => e.muscles_primary === muscleFilter);
            }
            
            if (equipmentFilter !== 'all') {
                filtered = filtered.filter(e => e.equipment === equipmentFilter);
            }
            
            const grid = document.getElementById('exerciseGrid');
            grid.innerHTML = '';
            
            filtered.forEach(exercise => {
                const card = document.createElement('div');
                card.className = 'exercise-card';
                
                const secondary = exercise.muscles_secondary.length > 0 
                    ? ` + ${exercise.muscles_secondary.join(', ')}` 
                    : '';
                
                card.innerHTML = `
                    <div class="exercise-header">
                        <div>
                            <div class="exercise-name">${exercise.name}</div>
                            <div class="exercise-muscles">
                                <span style="color: ${appState.muscleColors[exercise.muscles_primary]}; font-weight: 700;">
                                    ${exercise.muscles_primary}
                                </span>${secondary}
                            </div>
                            <div class="exercise-equipment">${exercise.equipment}</div>
                        </div>
                        <button class="add-exercise-btn" onclick="showAddExerciseModal('${exercise.name}')">
                            + Add
                        </button>
                    </div>
                `;
                
                card.onclick = (e) => {
                    if (!e.target.classList.contains('add-exercise-btn')) {
                        showExerciseDetail(exercise.name);
                    }
                };
                
                grid.appendChild(card);
            });
        }
        
        function showExerciseDetail(exerciseName) {
            const exercise = appState.exercises.find(e => e.name === exerciseName);
            if (!exercise) return;
            
            document.getElementById('modalExerciseName').textContent = exercise.name;
            
            let html = `
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; gap: 16px; margin-bottom: 16px;">
                        <div style="flex: 1;">
                            <div style="color: var(--color-text-muted); font-size: 12px; margin-bottom: 4px;">PRIMARY MUSCLE</div>
                            <div style="color: ${appState.muscleColors[exercise.muscles_primary]}; font-weight: 700; font-size: 18px;">
                                ${exercise.muscles_primary}
                            </div>
                        </div>
                        <div style="flex: 1;">
                            <div style="color: var(--color-text-muted); font-size: 12px; margin-bottom: 4px;">EQUIPMENT</div>
                            <div style="font-weight: 700; font-size: 18px;">${exercise.equipment}</div>
                        </div>
                    </div>
                    ${exercise.muscles_secondary.length > 0 ? `
                        <div>
                            <div style="color: var(--color-text-muted); font-size: 12px; margin-bottom: 4px;">SECONDARY MUSCLES</div>
                            <div style="font-weight: 600;">${exercise.muscles_secondary.join(', ')}</div>
                        </div>
                    ` : ''}
                </div>
            `;
            
            html += '<h3 style="margin-bottom: 16px; font-size: 20px;">Demo Videos</h3>';
            html += '<div class="video-grid">';
            exercise.videos.forEach(video => {
                html += `
                    <div class="video-wrapper">
                        <iframe src="${video}" allowfullscreen></iframe>
                    </div>
                `;
            });
            html += '</div>';
            
            // Show exercise history
            const history = getExerciseHistory(exerciseName);
            if (history.length > 0) {
                html += `
                    <div style="margin-top: 32px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h3 style="font-size: 20px;">Your History</h3>
                            <button class="calendar-btn" onclick="showExerciseHistory('${exerciseName}')">
                                View Timeline
                            </button>
                        </div>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value">${history.length}</div>
                                <div class="stat-label">Times Performed</div>
                            </div>
                            ${history[0].weight ? `
                                <div class="stat-card">
                                    <div class="stat-value">${Math.max(...history.map(h => h.weight || 0))}kg</div>
                                    <div class="stat-label">Max Weight</div>
                                </div>
                            ` : ''}
                            ${history[0].sets ? `
                                <div class="stat-card">
                                    <div class="stat-value">${history.reduce((sum, h) => sum + (h.sets || 0), 0)}</div>
                                    <div class="stat-label">Total Sets</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
            
            html += `
                <form class="kpi-form" onsubmit="addExerciseToTracker(event, '${exerciseName}')">
                    <h3 style="margin-bottom: 16px; font-size: 18px;">Add to Today's Workout</h3>
                    <div class="form-grid" id="exerciseKpiForm">
                        ${generateKpiForm(exercise.kpiType)}
                    </div>
                    <button type="submit" class="form-submit">Add to Tracker</button>
                </form>
            `;
            
            document.getElementById('modalExerciseDetails').innerHTML = html;
            document.getElementById('exerciseModal').classList.add('active');
        }
        
        function getExerciseHistory(exerciseName) {
            const history = [];
            appState.workouts.forEach(workout => {
                const exercise = workout.exercises.find(e => e.name === exerciseName);
                if (exercise) {
                    history.push({ ...exercise, date: workout.date });
                }
            });
            return history.sort((a, b) => new Date(b.date) - new Date(a.date));
        }
        
        function showExerciseHistory(exerciseName) {
            closeModal('exerciseModal');
            
            document.getElementById('modalExerciseHistoryName').textContent = `${exerciseName} - Timeline`;
            
            const history = getExerciseHistory(exerciseName);
            
            // Create chart
            const ctx = document.getElementById('exerciseHistoryChart').getContext('2d');
            
            if (appState.charts.exerciseHistory) {
                appState.charts.exerciseHistory.destroy();
            }
            
            const sortedHistory = [...history].sort((a, b) => new Date(a.date) - new Date(b.date));
            
            const labels = sortedHistory.map(h => {
                const date = new Date(h.date);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });
            
            const datasets = [];
            
            if (sortedHistory[0].weight) {
                datasets.push({
                    label: 'Weight (kg)',
                    data: sortedHistory.map(h => h.weight),
                    borderColor: '#4ECDC4',
                    backgroundColor: '#4ECDC433',
                    yAxisID: 'y'
                });
            }
            
            if (sortedHistory[0].sets) {
                datasets.push({
                    label: 'Sets',
                    data: sortedHistory.map(h => h.sets),
                    borderColor: '#FF6B9D',
                    backgroundColor: '#FF6B9D33',
                    yAxisID: 'y1'
                });
            }
            
            if (sortedHistory[0].reps) {
                datasets.push({
                    label: 'Reps',
                    data: sortedHistory.map(h => h.reps),
                    borderColor: '#FFD93D',
                    backgroundColor: '#FFD93D33',
                    yAxisID: 'y1'
                });
            }
            
            if (sortedHistory[0].duration) {
                datasets.push({
                    label: 'Duration (min)',
                    data: sortedHistory.map(h => h.duration),
                    borderColor: '#95E1D3',
                    backgroundColor: '#95E1D333',
                    yAxisID: 'y'
                });
            }
            
            appState.charts.exerciseHistory = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#e8eaf0',
                                font: { weight: 600 }
                            }
                        },
                        tooltip: {
                            backgroundColor: '#1a1f3a',
                            titleColor: '#e8eaf0',
                            bodyColor: '#e8eaf0',
                            borderColor: '#4ECDC4',
                            borderWidth: 2
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            grid: { color: 'rgba(78, 205, 196, 0.1)' },
                            ticks: { color: '#a0a8c0' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: { drawOnChartArea: false },
                            ticks: { color: '#a0a8c0' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#a0a8c0' }
                        }
                    }
                }
            });
            
            // Show history list
            let html = '';
            history.forEach(h => {
                const date = new Date(h.date);
                const formattedDate = date.toLocaleDateString('en-US', { 
                    month: 'short', day: 'numeric', year: 'numeric' 
                });
                
                let details = '';
                if (h.sets && h.reps && h.weight) {
                    details = `${h.sets} sets √ó ${h.reps} reps @ ${h.weight}kg`;
                } else if (h.sets && h.reps) {
                    details = `${h.sets} sets √ó ${h.reps} reps`;
                } else if (h.duration) {
                    details = `${h.duration} min`;
                }
                
                html += `
                    <div class="exercise-log">
                        <div class="exercise-log-header">
                            <div class="exercise-log-name">${formattedDate}</div>
                        </div>
                        <div class="exercise-log-details">${details}</div>
                    </div>
                `;
            });
            
            document.getElementById('exerciseHistoryList').innerHTML = html;
            document.getElementById('exerciseHistoryModal').classList.add('active');
        }
        
        function generateKpiForm(kpiTypes) {
            let html = '';
            
            if (kpiTypes.includes('sets')) {
                html += `
                    <div class="form-group">
                        <label class="form-label">Sets</label>
                        <input type="number" class="form-input" name="sets" required min="1">
                    </div>
                `;
            }
            
            if (kpiTypes.includes('reps')) {
                html += `
                    <div class="form-group">
                        <label class="form-label">Reps</label>
                        <input type="number" class="form-input" name="reps" required min="1">
                    </div>
                `;
            }
            
            if (kpiTypes.includes('weight')) {
                html += `
                    <div class="form-group">
                        <label class="form-label">Weight (kg)</label>
                        <input type="number" step="0.5" class="form-input" name="weight" required min="0">
                    </div>
                `;
            }
            
            if (kpiTypes.includes('duration')) {
                html += `
                    <div class="form-group">
                        <label class="form-label">Duration (min)</label>
                        <input type="number" step="0.1" class="form-input" name="duration" required min="0.1">
                    </div>
                `;
            }
            
            return html;
        }
        
        function showAddExerciseModal(exerciseName) {
            // If exerciseName is provided, show exercise detail instead
            if (exerciseName && typeof exerciseName === 'string') {
                showExerciseDetail(exerciseName);
                return;
            }
            
            // Populate muscle groups
            const primaryMuscleSelect = document.getElementById('newExercisePrimaryMuscle');
            primaryMuscleSelect.innerHTML = '<option value="">Select Muscle</option>';
            appState.muscleGroups.forEach(muscle => {
                const option = document.createElement('option');
                option.value = muscle;
                option.textContent = muscle;
                primaryMuscleSelect.appendChild(option);
            });
            
            document.getElementById('addExerciseModal').classList.add('active');
        }
        
        function addExerciseToTracker(event, exerciseName) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const exerciseData = { name: exerciseName };
            
            for (let [key, value] of formData.entries()) {
                exerciseData[key] = parseFloat(value);
            }
            
            const today = new Date().toISOString().split('T')[0];
            let workout = appState.workouts.find(w => w.date === today);
            
            if (!workout) {
                workout = { date: today, exercises: [] };
                appState.workouts.push(workout);
            }
            
            workout.exercises.push(exerciseData);
            
            closeModal('exerciseModal');
            
            // Show success message
            alert(`${exerciseName} added to today's workout!`);
            
            // Refresh calendar and stats
            renderCalendar();
            renderMuscleStats();
            
            // Auto-sync if enabled
            autoSyncIfEnabled();
        }
        
        // Stats Functions
        function updateStats() {
            // Total workouts
            document.getElementById('totalWorkouts').textContent = appState.workouts.length;
            
            // Current streak
            let streak = 0;
            const sortedWorkouts = [...appState.workouts].sort((a, b) => 
                new Date(b.date) - new Date(a.date)
            );
            
            let currentDate = new Date();
            currentDate.setHours(0, 0, 0, 0);
            
            for (let workout of sortedWorkouts) {
                const workoutDate = new Date(workout.date);
                workoutDate.setHours(0, 0, 0, 0);
                
                const diffDays = Math.floor((currentDate - workoutDate) / (1000 * 60 * 60 * 24));
                
                if (diffDays === streak || (streak === 0 && diffDays <= 1)) {
                    streak++;
                    currentDate.setDate(currentDate.getDate() - 1);
                } else {
                    break;
                }
            }
            
            document.getElementById('currentStreak').textContent = streak;
            
            // Weeks completed (5 days per week)
            const weeksCompleted = Math.floor(appState.workouts.length / 5);
            document.getElementById('weeksCompleted').textContent = weeksCompleted;
            
            // This week
            const now = new Date();
            const startOfWeek = new Date(now);
            startOfWeek.setDate(now.getDate() - now.getDay());
            startOfWeek.setHours(0, 0, 0, 0);
            
            const thisWeek = appState.workouts.filter(w => {
                const date = new Date(w.date);
                return date >= startOfWeek && date <= now;
            });
            
            document.getElementById('thisWeekDays').textContent = thisWeek.length;
        }
        
        // Modal Functions
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }
        
        // Initialize App
        function initApp() {
            renderCalendar();
            renderBodyMap();
            renderMuscleStats();
            renderMetricChart();
            updateCurrentBMI();
            updateStats();
        }
        
        // Export Data Functions
        function downloadWorkoutsCSV() {
            const csv = generateWorkoutsCSV();
            downloadCSV(csv, 'fit-trackr-workouts.csv');
            alert('Workout history downloaded successfully!');
        }
        
        function downloadMetricsCSV() {
            const csv = generateMetricsCSV();
            downloadCSV(csv, 'fit-trackr-metrics.csv');
            alert('Body metrics downloaded successfully!');
        }
        
        function downloadExercisesCSV() {
            const csv = generateExercisesCSV();
            downloadCSV(csv, 'fit-trackr-exercises.csv');
            alert('Exercise library downloaded successfully!');
        }
        
        function generateWorkoutsCSV() {
            let csv = 'Date,Exercise,Muscle Group,Equipment,Sets,Reps,Weight (kg),Duration (min)\n';
            
            appState.workouts.forEach(workout => {
                workout.exercises.forEach(ex => {
                    const exercise = appState.exercises.find(e => e.name === ex.name);
                    const muscleGroup = exercise ? exercise.muscles_primary : '';
                    const equipment = exercise ? exercise.equipment : '';
                    
                    csv += `${workout.date},${ex.name},${muscleGroup},${equipment},`;
                    csv += `${ex.sets || ''},${ex.reps || ''},${ex.weight || ''},${ex.duration || ''}\n`;
                });
            });
            
            return csv;
        }
        
        function generateMetricsCSV() {
            let csv = 'Date,Weight (kg),Body Fat %,BMI,Height (cm)\n';
            
            const heightM = appState.userHeight / 100;
            
            appState.metrics.forEach(metric => {
                const bmi = metric.weight ? (metric.weight / (heightM * heightM)).toFixed(1) : '';
                csv += `${metric.date},${metric.weight || ''},${metric.bodyFat || ''},${bmi},${appState.userHeight}\n`;
            });
            
            return csv;
        }
        
        function generateExercisesCSV() {
            let csv = 'Exercise Name,Primary Muscle,Secondary Muscles,Equipment,KPI Types,Video Count\n';
            
            appState.exercises.forEach(exercise => {
                const secondary = exercise.muscles_secondary.join('; ');
                const kpiTypes = exercise.kpiType.join('; ');
                const videoCount = exercise.videos.length;
                
                csv += `${exercise.name},${exercise.muscles_primary},"${secondary}",${exercise.equipment},"${kpiTypes}",${videoCount}\n`;
            });
            
            return csv;
        }
        
        function downloadCSV(csvContent, filename) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (navigator.msSaveBlob) {
                // IE 10+
                navigator.msSaveBlob(blob, filename);
            } else {
                const url = URL.createObjectURL(blob);
                link.href = url;
                link.download = filename;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }
        }
        
        // Google Sheets Integration
        function saveGoogleSheetsUrl() {
            const url = document.getElementById('googleSheetsUrlInput').value.trim();
            if (!url) {
                alert('Please enter a valid Google Apps Script URL');
                return;
            }
            
            if (!url.includes('script.google.com') && !url.includes('https://')) {
                alert('Please enter a valid Google Apps Script Web App URL');
                return;
            }
            
            appState.googleSheetsUrl = url;
            localStorage.setItem('fitTrackrGoogleSheetsUrl', url);
            localStorage.setItem('fitTrackrAutoSync', document.getElementById('autoSyncToggle').checked);
            
            showSyncStatus('‚úÖ Google Sheets URL saved successfully!', 'success');
        }
        
        function toggleAutoSync() {
            const enabled = document.getElementById('autoSyncToggle').checked;
            localStorage.setItem('fitTrackrAutoSync', enabled);
            showSyncStatus(enabled ? '‚úÖ Auto-sync enabled' : '‚ö†Ô∏è Auto-sync disabled', 'info');
        }
        
        async function syncToGoogleSheets() {
            if (!appState.googleSheetsUrl) {
                alert('Please configure Google Sheets URL in Settings first');
                return;
            }
            
            if (appState.isSyncing) {
                showSyncStatus('‚è≥ Sync already in progress...', 'info');
                return;
            }
            
            appState.isSyncing = true;
            showSyncStatus('‚è≥ Syncing to Google Sheets...', 'info');
            
            try {
                // Sync workouts
                const workoutData = {
                    type: 'workouts',
                    workouts: appState.workouts.map(w => ({
                        ...w,
                        exercises: w.exercises.map(ex => {
                            const exercise = appState.exercises.find(e => e.name === ex.name);
                            return {
                                ...ex,
                                muscle: exercise ? exercise.muscles_primary : ''
                            };
                        })
                    }))
                };
                
                await fetch(appState.googleSheetsUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(workoutData)
                });
                
                // Sync metrics
                const heightM = appState.userHeight / 100;
                const metricsData = {
                    type: 'metrics',
                    metrics: appState.metrics.map(m => ({
                        ...m,
                        bmi: m.weight ? (m.weight / (heightM * heightM)).toFixed(1) : ''
                    }))
                };
                
                await fetch(appState.googleSheetsUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(metricsData)
                });
                
                // Sync exercises
                const exerciseData = {
                    type: 'exercises',
                    exercises: appState.exercises.map(ex => ({
                        name: ex.name,
                        primary: ex.muscles_primary,
                        secondary: ex.muscles_secondary.join(', '),
                        equipment: ex.equipment,
                        videos: ex.videos.length
                    }))
                };
                
                await fetch(appState.googleSheetsUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(exerciseData)
                });
                
                showSyncStatus('‚úÖ Successfully synced to Google Sheets!', 'success');
                
            } catch (error) {
                console.error('Sync error:', error);
                showSyncStatus('‚ùå Sync failed. Please check your URL and try again.', 'error');
            } finally {
                appState.isSyncing = false;
            }
        }
        
        async function loadFromGoogleSheets() {
            if (!appState.googleSheetsUrl) {
                alert('Please configure Google Sheets URL in Settings first');
                return;
            }
            
            showSyncStatus('‚è≥ Loading from Google Sheets...', 'info');
            
            try {
                // Note: Loading from Sheets requires CORS configuration
                // This is a placeholder - actual implementation may need backend proxy
                showSyncStatus('‚ö†Ô∏è Load from Sheets: Please use Export/Import for now', 'info');
                
            } catch (error) {
                console.error('Load error:', error);
                showSyncStatus('‚ùå Load failed. Use CSV export/import instead.', 'error');
            }
        }
        
        function showSyncStatus(message, type) {
            const status = document.getElementById('syncStatus');
            status.style.display = 'block';
            status.textContent = message;
            
            if (type === 'success') {
                status.style.background = 'rgba(78, 205, 196, 0.2)';
                status.style.border = '2px solid var(--color-primary)';
                status.style.color = 'var(--color-primary)';
            } else if (type === 'error') {
                status.style.background = 'rgba(255, 107, 157, 0.2)';
                status.style.border = '2px solid var(--color-secondary)';
                status.style.color = 'var(--color-secondary)';
            } else {
                status.style.background = 'rgba(255, 217, 61, 0.2)';
                status.style.border = '2px solid var(--color-accent)';
                status.style.color = 'var(--color-accent)';
            }
            
            setTimeout(() => {
                status.style.display = 'none';
            }, 5000);
        }
        
        function showGoogleSheetsSetup() {
            document.getElementById('googleSheetsSetupModal').classList.add('active');
        }
        
        function autoSyncIfEnabled() {
            const autoSync = localStorage.getItem('fitTrackrAutoSync') === 'true';
            if (autoSync && appState.googleSheetsUrl) {
                syncToGoogleSheets();
            }
        }
        
        // Load saved Google Sheets URL on init
        function loadSettings() {
            const savedUrl = localStorage.getItem('fitTrackrGoogleSheetsUrl');
            const autoSync = localStorage.getItem('fitTrackrAutoSync') === 'true';
            
            if (savedUrl) {
                appState.googleSheetsUrl = savedUrl;
                document.getElementById('googleSheetsUrlInput').value = savedUrl;
            }
            
            document.getElementById('autoSyncToggle').checked = autoSync;
        }
        
        // Run on load
        window.addEventListener('load', () => {
            initApp();
            loadSettings();
        });
        
        // Close modals on background click
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });
    </script>
</body>
</html>
